<!DOCTYPE html><html xml:lang="ja" lang="ja"><head>
<title>camp2024(スタッフ)</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- QRコード検出 --><script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<!-- alasql --><script src="https://cdn.jsdelivr.net/npm/alasql@4.5.1/dist/alasql.min.js"></script>
<style type="text/css">
html {
  font-size: 24pt;
  font:helvetica,arial,freesans,clean,sans-serif;
  line-height: 1.5rem;
  color: black;
  box-sizing: border-box;
  width: 100vw;
  height: 100%;
  margin: 0;
  padding: 0;
}

body {
  width: 100%;
  min-height: 100vh;
  -webkit-text-size-adjust: none;
  -moz-text-size-adjust: none;
  text-size-adjust: none;
}

* {
  margin: 0;
  padding: 0;
  font-size: 1rem;
  overflow-wrap: anywhere;
}
.right, .num {text-align: right;}
/*
  ヘッダ関係
*/
h1,h2,h3,h4,h5,h6 {border: 0;}
h1 {
  margin: 1rem;
  width: calc(100% - 2rem);
  font-size: 170%;
  text-shadow: #8ff 3px 3px 15px;
  font-weight: 900;
}
h2, h3 {margin: 1rem 0;}
h2 {
  font-size: 150%;
  margin-top: 1.5rem;
  border-bottom: 1px solid #ddd;
  padding-bottom: 0.5rem;
}
/*
  テーブル関係
*/
th, .th {padding: 0.3rem;background-color: #888;color: white;}
td, .td {padding: 0.3rem;border-bottom: solid 1px #aaa;border-right: solid 1px #aaa;}
/*
  リスト関係
*/
ul, ol {margin: 1rem 0 1rem 2rem;}
li {margin-top: 0.5rem;margin-bottom: 0.5rem;}
/*
  ソース表示
*/
code {
  background-color: #f8f8ff;
  color: #444;
  padding: 0 0.2rem;
  border: 1px solid #dedede;
}
pre {border: solid 5px #999;}
/* Reception共通 */
  .Reception div {display: grid;}
  .Reception rt {font-size: 0.6rem;}
  .Reception dialog {margin: auto;box-shadow: 0 0 1rem black;padding: 1rem;}
  .Reception dialog::backdrop {background-color: #ddd;/*backdrop-filter: blur(8px);*/}

  /* scanner領域 */
  .Reception [name="scanner"] [name="keyword"] {display: block;margin:1rem;}
  .Reception [name="scanner"] [name="keyword"] input {display: inline-block;margin-right: 1rem;font-size: 2rem;}
  .Reception [name="scanner"] [name="keyword"] button {display: inline-block;font-size: 2rem;}
  .Reception [name="scanner"] dialog .act {background-color: #ddd;}

  /* detail領域 */
  .Reception [name="detail"] {padding:1rem;grid-template-columns: repeat(12, 1fr);}
  .Reception [name="detail"] h2 {margin:0.5rem 0;padding: 0.5rem 1rem;border-left: 5px solid #000;background: #f4f4f4;grid-column: 1/13;}
  .Reception [name="detail"] div {grid-column: 1/13;}
  /* detail領域 申込情報 */
  .Reception [name="detail"] [name="キャンセル"] {margin:2rem 0;font-size:3rem; color:red;}
  .Reception [name="detail"] .c19 {grid-column: 1/9;} /* column 1 to 9 */
  .Reception [name="detail"] .c9d {grid-column: 9/13;grid-row: 3/7;} /* column 9 to 13(=0x0d) */
  .Reception [name="detail"] ruby.big span {font-size: 1.5rem;}
  .Reception [name="detail"] rt.big {font-size: 1rem;}
  .Reception [name="detail"] img {margin:auto;}
  .Reception [name="detail"] sub {font-size:0.8rem;text-align: center;}
  /* detail領域 参加者情報 */
  .Reception [name="detail"] table {grid-column: 1/13}
  .Reception [name="detail"] td {border: none;}
  .Reception [name="detail"] input {margin:0 0.6rem;transform: scale(3.0);}
  /* detail領域 その他 */
  .Reception [name="detail"] .c14 {grid-column: 1/4;}
  .Reception [name="detail"] .c4d {grid-column: 4/13;margin-bottom: 0.6rem;}
  .Reception [name="detail"] textarea {height: 5rem;}
  /* detail領域 ボタン */
  .Reception [name="detail"] [name="button"] { margin: 1rem;
    grid-column: 1/13; grid-template-columns: repeat(3, 1fr); gap: 1rem;}
  .Reception [name="detail"] [name="button"] button {
    width:100%; aspect-ratio: 1/1; font-size: 2rem;}
.LinkCollection .title {
  margin: 2rem 20px 10px 20px;
  padding: 10px;
  width: calc(100% - 60px);
  background: #ddd;
  font-size: 1.4rem;
  font-weight: 900;
}
.LinkCollection .tr {
  margin: 20px;
  padding: 20px;
  width: calc(100% - 80px);
  display: grid;
  gap: 1rem;
  grid-template-columns: 1fr 200px;
}
.LinkCollection p {
  margin-bottom: 1rem;
  font-family: serif;
}
.LinkCollection img {
  width: 200px;
  height: 200px;
}
</style>
</head>
<body>
  <div class="BurgerMenu" name="wrapper">
    <div data-BurgerMenu="id:'ホーム'">
<h1 id="スタッフ専用サイトホーム">「スタッフ専用サイト」ホーム</h1>
<ul>
<li>右上の「三」アイコン(ハンバーガーメニュー)から選択してください</li>
<li>連続3回不適切なパスコードが入力された場合、アカウントが凍結されます。即時凍結解除が必要な場合、システム管理者(嶋津)まで直接ご連絡ください。</li>
<li>パスコードは10分以内に入力してください</li>
</ul>
<!--
- リロードした場合、パスコード入力ダイアログでキャンセルした場合も1回失敗と看做します。
- 受付業務では個人情報もアクセス可能になるため、＋αの権限が必要です。受付業務を行う場合、システム管理者(嶋津)まで直接ご連絡ください。
-->
    </div>
    <div data-BurgerMenu="id:マニュアル">
      <div data-BurgerMenu="id:受付業務マニュアル">
<h1>
受付業務マニュアル
</h1>
<h2 id="イベント前日までに">イベント前日までに</h2>
<ol type="1">
<li>参加者名簿を紙で出力(障害時用)</li>
</ol>
<h2 id="受付開始準備">受付開始準備</h2>
<ol type="1">
<li>動線の確認、机の準備</li>
<li>受付待機列整理用にコーンや白線等を用意</li>
<li>役割分担</li>
<li>机上に以下が揃っているか確認
<ul>
<li>おつり用コイン</li>
<li>手提げ金庫</li>
<li>参加者識別用ガムテープ</li>
<li>参加者名簿、チェック用ペン</li>
<li>メモ用紙、</li>
<li>文鎮</li>
</ul></li>
</ol>
<h2 id="受付の手順">受付の手順</h2>
<ol type="1">
<li>[参加者]
申込受付メールでQRコードを準備。分かれば受付番号、分からなければ氏名の一部で検索</li>
<li>「メニュー &gt; 受付業務」を選択</li>
<li>参加者から申込受付メール(QRコード)を提示いただき、スキャン
または受付番号・氏名(一部)から検索</li>
<li>複数の候補がいる場合、該当者をタップして「選択」</li>
<li>申込情報の内容確認
<ul>
<li>以下の場合、参加者に画面右の「申込フォームの修正」(QRコード)から修正してもらう<br>
※スマホがない等、対応不能なら修正不要
<ul>
<li>参加者に増減が有った場合</li>
<li>キャンセルされているのに来場した場合</li>
</ul></li>
<li>テント泊以外でテントを持ち込んでいないか</li>
<li>引取者が決まっているか</li>
</ul></li>
<li>特記事項があればメモ欄に記入</li>
<li>ボタンクリックして確定。全員分なら「全員受領」、一部なら該当者分を「既収」にして「更新」</li>
<li>参加費を収納、参加者識別用ガムテープを見やすい位置に貼付</li>
</ol>
<h2 id="受付が終わったら">受付が終わったら</h2>
<ol type="1">
<li>受領した参加費を本部に持参</li>
</ol>
      </div>
    </div>
    <div data-BurgerMenu="id:'受付業務',func:'recept'"><div class="Reception" name="wrapper">
<div name="scanner"><!-- スキャナ＋キーワード入力領域 -->
      <div name="camera"></div><!-- スキャナ領域。scanQRの包摂要素 -->
      <div name="keyword"><!-- キーワード入力領域 -->
        <p>受付番号、または申込者の氏名・カナ(一部可)を入力してください</p>
        <input type="text">
        <button>検索</button>
        <div name="val" style="display: none;"></div>
      </div>
      <dialog><!-- 検索結果が複数時の候補者一覧表示画面 -->
        <p>複数の候補が見つかりました</p>
        <div name="list"></div>
        <button>選択</button>
      </dialog>
    </div>
  
    <div name="detail"><!-- 申込情報詳細画面 -->
      <div name="entryNo" style="display: none;"></div>
      <div name="キャンセル"></div>
      <h2>申込情報</h2>
      <div class="c19"><ruby class="big"><span name="申込者氏名">嶋津　邦浩</span><rt name="申込者カナ" class="big">シマヅ　クニヒロ</rt></ruby></div>
      <div name="editURL" class="c9d">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&amp;data=https://chiilabo.co.jp/2024-05/wordpress-replace-qr-code-generater-api-post/">
        <sub>申込フォーム修正</sub>
      </div>
      <div name="メールアドレス" class="c19">nakaone.kunihiro@gmail.com</div>
      <div class="c19" name="緊急連絡先">090-6511-1788</div>
      <div class="c19">ボランティア：<span name="ボランティア募集"></span></div>

      <h2>参加者情報</h2>
      <table style="grid-column: 1/13;"><tbody><tr name="参加者01">
        <td><ruby>
          <span name="参加者01氏名">嶋津　邦浩</span>
          <rt name="参加者01カナ">シマヅ　クニヒロ</rt>
        </ruby></td>
        <td name="参加者01所属">卒業生</td>
        <td><form name="参加者01会費">
          <label><input type="radio" name="fee01" value="未収"><span>未収</span></label>
          <label><input type="radio" name="fee01" value="既収"><span>既収</span></label>
          <label><input type="radio" name="fee01" value="無料"><span>無料</span></label>  
        </form></td>
      </tr><tr name="参加者02">
        <td><ruby>
          <span name="参加者02氏名">嶋津　弘子</span>
          <rt name="参加者02カナ">シマヅ　ヒロコ</rt>
        </ruby></td>
        <td name="参加者02所属">卒業生</td>
        <td><form name="参加者02会費">
          <label><input type="radio" name="fee02" value="未収"><span>未収</span></label>
          <label><input type="radio" name="fee02" value="既収"><span>既収</span></label>
          <label><input type="radio" name="fee02" value="無料"><span>無料</span></label>  
        </form></td>
      </tr><tr name="参加者03">
        <td><ruby>
          <span name="参加者03氏名">嶋津　諒</span>
          <rt name="参加者03カナ">シマヅ　リョウ</rt>
        </ruby></td>
        <td name="参加者03所属">卒業生</td>
        <td><form name="参加者03会費">
          <label><input type="radio" name="fee03" value="未収"><span>未収</span></label>
          <label><input type="radio" name="fee03" value="既収"><span>既収</span></label>
          <label><input type="radio" name="fee03" value="無料"><span>無料</span></label>  
        </form></td>
      </tr><tr name="参加者04">
        <td><ruby>
          <span name="参加者04氏名">嶋津　史奈</span>
          <rt name="参加者04カナ">シマヅ　フミナ</rt>
        </ruby></td>
        <td name="参加者04所属">卒業生</td>
        <td><form name="参加者04会費">
          <label><input type="radio" name="fee04" value="未収"><span>未収</span></label>
          <label><input type="radio" name="fee04" value="既収"><span>既収</span></label>
          <label><input type="radio" name="fee04" value="無料"><span>無料</span></label>  
        </form></td>
      </tr><tr name="参加者05">
        <td><ruby>
          <span name="参加者05氏名">嶋津　悠奈</span>
          <rt name="参加者05カナ">シマヅ　ユウナ</rt>
        </ruby></td>
        <td name="参加者05所属">卒業生</td>
        <td><form name="参加者05会費">
          <label><input type="radio" name="fee05" value="未収"><span>未収</span></label>
          <label><input type="radio" name="fee05" value="既収"><span>既収</span></label>
          <label><input type="radio" name="fee05" value="無料"><span>無料</span></label>  
        </form></td>
      </tr></tbody></table>

      <h2>その他</h2>
      <div class="c14">申込者の参加</div>
      <div class="c4d" name="申込者の参加">参加予定(宿泊あり)</div>
      <div class="c14">宿泊、テント</div>
      <div class="c4d" name="宿泊、テント">宿泊する(テントあり)</div>
      <div class="c14">引取者氏名</div>
      <div class="c4d" name="引取者氏名">申込者が参加して帰宅時の付添もするのでお迎えは不要</div>
      <div class="c14">備考</div>
      <div class="c4d" name="備考">(無記入)</div>
      <div class="c14">メモ</div>
      <div><textarea name="memo" placeholder="受付時等にスタッフが記入"></textarea></div>

      <div name="button">
        <button name="cancel">取消</button>
        <button name="update">更新</button>
        <button name="updall">全員<br>受領</button>
      </div>
    </div>
    </div></div>
    <div data-BurgerMenu="id:'参加者集計'">
      <div title="summaryTable">
        <h1>参加申込口数・人数集計</h1>
        <div title="wrapper"></div>
        <ol>
          <li>申込口数におやじの会メンバの申込は含まれません</li>
          <li>宿泊には日帰り予定の保護者を含む(例：母申込で日帰り、子供＋父がテント泊)</li>
        </ol>
      </div>
    </div>
    <div data-BurgerMenu="id:'お気づきの点',func:'awareness'"></div>
    <!--div data-BurgerMenu="id:'写真共有'">
      <h1>写真共有</h1>
    </div-->
    <div data-BurgerMenu="id:'リンク集'">
      <h1>リンク集</h1>
<div class="LinkCollection">

    <!-- 「困ったときは」(FAQサイト) -->
    <div class="title" data-assign="innerText:faq.title"></div>
    <div class="tr">
      <div>
        <p><span data-assign="innerText:faq.view"></span> 
          [<a data-assign="href:faq.view" target="_blank">jump</a>]</p>
        <p>短縮URL : <span data-assign="innerText:faq.shortView"></span></p>
      </div>
      <div><img data-assign="src:faq.qr"></div>
    </div>
    
    <!-- 一般公開サイト -->
    <div class="title" data-assign="innerText:publicSite.title"></div>
    <div class="tr">
      <div>
        <p><span data-assign="innerText:publicSite.url"></span> 
          [<a data-assign="href:publicSite.url" target="_blank">jump</a>]</p>
        <p>短縮URL : <span data-assign="innerText:publicSite.shortURL"></span></p>
      </div>
      <div><img data-assign="src:publicSite.qr"></div>
    </div>
    
    <!-- スタッフ専用サイト -->
    <div class="title" data-assign="innerText:staffSite.title"></div>
    <div class="tr">
      <div>
        <p><span data-assign="innerText:staffSite.url"></span> 
          [<a data-assign="href:staffSite.url" target="_blank">jump</a>]</p>
        <p>短縮URL : <span data-assign="innerText:staffSite.shortURL"></span></p>
      </div>
      <div><img data-assign="src:staffSite.qr"></div>
    </div>
    
    <!-- 参加申込フォーム -->
    <div class="title" data-assign="innerText:entry.title"></div>
    <div class="tr">
      <div>
        <p><span data-assign="innerText:entry.view"></span> 
          [<a data-assign="href:entry.view" target="_blank">jump</a>]</p>
        <p>短縮URL : <span data-assign="innerText:entry.shortView"></span></p>
      </div>
      <div><img data-assign="src:entry.qr"></div>
    </div>
    
    <!-- ボランティア募集フォーム -->
    <div class="title" data-assign="innerText:volunteer.title"></div>
    <div class="tr">
      <div>
        <p><span data-assign="innerText:volunteer.view"></span> 
          [<a data-assign="href:volunteer.view" target="_blank">jump</a>]</p>
        <p>短縮URL : <span data-assign="innerText:volunteer.shortView"></span></p>
      </div>
      <div><img data-assign="src:volunteer.qr"></div>
    </div>
    
    <!-- 参加者アンケートフォーム -->
    <div class="title" data-assign="innerText:participantEnquete.title"></div>
    <div class="tr">
      <div>
        <p><span data-assign="innerText:participantEnquete.view"></span> 
          [<a data-assign="href:participantEnquete.view" target="_blank">jump</a>]</p>
        <p>短縮URL : <span data-assign="innerText:participantEnquete.shortView"></span></p>
      </div>
      <div><img data-assign="src:participantEnquete.qr"></div>
    </div>
    
    <!-- 気づき投稿フォーム -->
    <div class="title" data-assign="innerText:awareness.title"></div>
    <div class="tr">
      <div>
        <p><span data-assign="innerText:awareness.view"></span> 
          [<a data-assign="href:awareness.view" target="_blank">jump</a>]</p>
        <p>短縮URL : <span data-assign="innerText:awareness.shortView"></span></p>
      </div>
      <div><img data-assign="src:awareness.qr"></div>
    </div>
    
    <!-- おやじの会ML登録 -->
    <div class="title" data-assign="innerText:oyajiML.title"></div>
    <div class="tr">
      <div>
        <p><span data-assign="innerText:oyajiML.view"></span> 
          [<a data-assign="href:oyajiML.view" target="_blank">jump</a>]</p>
        <p>短縮URL : <span data-assign="innerText:oyajiML.shortView"></span></p>
        <p>登録確認 : <span data-assign="innerText:oyajiML.confirm"></span> 
          [<a data-assign="href:oyajiML.confirm" target="_blank">jump</a>]</p>
      </div>
      <div><img data-assign="src:oyajiML.qr"></div>
    </div>
    
  </div>
    </div>
  </div>
</body>
<script type="text/javascript" title="library">
/** assignVariables: 位置指定属性を持つHTML要素に変数を代入する
 * 
 * @example
 * 
 * ```
 * <a data-assing="href:public.refURL,innerText:title"></a>
 * <img data-assing="src:public.refQR" />
 * 
 * let r = assignVariables({
 *   attribute: 'data-assign',
 *   data: {
 *     title  : '参考資料',
 *     public: {
 *       refURL : 'https://〜',
 *       refQR  : 'https://api.qrserver.com/〜?data=' + 'https://〜',
 *     }
 *   },
 * });
 * 
 * <a href="https://〜">参考資料</a>
 * <img src="https://api.qrserver.com/〜?data=https://〜" />
 * ```
 * 
 * @param {Object} arg
 * @param {string} [arg.parent='body'] - 対象範囲となる包摂要素のCSSセレクタ
 * @param {string} [arg.attribute="data-assign"] - 位置指定属性の名称
 * @param {Object.<string, string>} arg.data - {属性名：値}となるオブジェクト
 * 
 * - 1.1.0 2024/08/16 : 階層化オブジェクトに対応
 */
function assignVariables(arg){
  const v = {whois:'assignVariables',step:0,rv:null};
  console.log(`${v.whois} start.\narg=${stringify(arg)}`);
  try {

    v.step = 1; // 事前準備
    v.arg = Object.assign({parent:'body',attribute:'data-assign'},arg);
    v.arg.data = JSON.stringify(arg.data);  // 壊れないよう文字列化
    v.parent = document.querySelector(v.arg.parent);
    v.elements = v.parent.querySelectorAll('['+v.arg.attribute+']');

    v.step = 2; // 対象要素毎に属性置換
    v.elements.forEach(element => {

      v.step = 2.1; // data-assign文字列をカンマで切り分け
      v.attributes = element.getAttribute(v.arg.attribute).split(',');
      v.attributes.forEach(attribute => {

        v.step = 2.2; // m[1]=属性名、m[2]=arg.dataのメンバ名に切り分け
        v.m = attribute.match(/(\w+)\s*:\s*([\w\.]+)/);

        v.step = 2.3; // '.'で階層毎に切り分け、arg.dataの該当メンバの値をv.dataにセット
        v.data = JSON.parse(v.arg.data);
        v.m[2].split('.').forEach(x => v.data = v.data[x]);

        v.step = 2.4; // HTML要素に適用
        if( v.m[1].match(/inner/) ){
          // innerText, innerHTML指定の場合
          element[v.m[1]] = v.data;
        } else {
          // innerText, innerHTML以外の、属性指定の場合
          element.setAttribute(v.m[1],v.data);
        }
      });
    });

    v.step = 9; // 終了処理
    console.log(`${v.whois} normal end.\nv.rv=${stringify(v.rv)}`);
    return v.rv;

  } catch(e) {
    e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
    console.error(`${e.message}\nv=${stringify(v)}`);
    return e;
  }
}
/**
 * @classdesc htmlからdata-BurgerMenu属性を持つ要素を抽出、ハンバーガーメニューを作成
 */
class BurgerMenu {

  /**
   * @constructor
   * @param {Object} arg 
   * @returns {BurgerMenu|Error}
   */
  constructor(arg={}){
    const v = {whois:this.constructor.name+'.constructor',rv:null,step:0};
    console.log(`${v.whois} start.\narg=${stringify(arg)}`);
    try {

      v.step = 1; // 引数と既定値からメンバの値を設定
      v.r = this.#setProperties(arg);
      if( v.r instanceof Error ) throw v.r;

      v.step = 2; // アイコン、ナビ、背景の作成
      v.step = 2.1; // アイコンの作成
      this.icon = createElement({
        attr:{class:'icon'},
        event:{click:this.toggle},
        children:[{
          tag:'button',
          children:[{tag:'span'},{tag:'span'},{tag:'span'}],
        }]
      },this.wrapper);
      v.step = 2.2; // ナビゲータの作成
        this.navi = createElement({
        tag:'nav',
      },this.wrapper);
      v.step = 2.3; // ナビゲータ背景の作成
        this.back = createElement({
        attr:{class:'back'},
        event:{click:this.toggle},
      },this.wrapper);

      v.step = 3; // 親要素を走査してナビゲーションを作成
      v.rv = this.genNavi();
      if( v.rv instanceof Error ) throw v.rv;

      v.step = 9; // 終了処理
      changeScreen(this.home);
      console.log(`${v.whois} normal end.`);
  
    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}`
      + `\n${e.message}`
      + `\narg=${stringify(arg)}`;  // 引数
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }

  /** constructorの引数と既定値からthisの値を設定
   * @param {Object} arg - constructorに渡された引数オブジェクト
   * @returns {null|Error}
   */
  #setProperties(arg){
    const v = {whois:this.constructor.name+'.setProperties',rv:null,step:0};
    console.log(`${v.whois} start.`);
    try {
  
      v.step = 1; // 既定値の定義
      v.default = {
        wrapper: `.${this.constructor.name}[name="wrapper"]`, // {string|HTMLElement}
        auth: 1, // ユーザ権限の既定値
        allow: 2 ** 32 - 1, // data-BurgerMenuのauth(開示範囲)の既定値
        func: {}, // {Object.<string,function>} メニューから呼び出される関数
        home: null,
        homeForEachAuth: null, // {Object.<number,string>} ユーザ権限毎にメニューを設定するなら、auth毎に.screen[name]を設定
        initialSubMenu: true, // サブメニューの初期状態。true:開いた状態、false:閉じた状態
      };
      v.default.css = `/* BurgerMenu専用CSS
          BurgerMenu共通変数定義
          --text: テキストおよびハンバーガーアイコンの線の色
          --maxIndex: ローディング画面優先なので、最大値2147483647-1
        */
        .BurgerMenu {
          --text : #000;
          --fore : #fff;
          --back : #ddd;
          --debug : rgba(255,0,0,1);
          --iconSize : 100px;
          --maxIndex : 2147483646;
          --navWidth : 0.7;
        }
        .BurgerMenu .screen {padding: 1rem;width: calc(100% - 2rem);}
        /* ハンバーガーアイコン
          icon周囲にiconSizeの40%程度の余白が必要なのでtop,rightを指定
        */
        .BurgerMenu .icon {
          display : flex;
          justify-content : flex-end;
          place-items : center;
          position : absolute;
          top : calc(var(--iconSize) * 0.4);
          right : calc(var(--iconSize) * 0.4);
          width : var(--iconSize);
          height : var(--iconSize);
          z-index : var(--maxIndex);
        }
        .BurgerMenu .icon > button {
          place-content : center center;
          display : block;
          margin : 0;
          padding : 0px;
          box-sizing : border-box;
          width : calc(var(--iconSize) * 0.7);
          height : calc(var(--iconSize) * 0.7);
          border : none;
          background : rgba(0,0,0,0);
          position : relative;
          box-shadow : none;
        }
        .BurgerMenu .icon button span {
          display : block;
          width : 100%;
          height : calc(var(--iconSize) * 0.12);
          border-radius : calc(var(--iconSize) * 0.06);
          position : absolute;
          left : 0;
          background : var(--text);
          transition : top 0.24s, transform 0.24s, opacity 0.24s;
        }
        .BurgerMenu .icon button span:nth-child(1) {
          top : 0;
        }
        .BurgerMenu .icon button span:nth-child(2) {
          top : 50%;
          transform : translateY(-50%);
        }
        .BurgerMenu .icon button span:nth-child(3) {
          top : 100%;
          transform : translateY(-100%);
        }
        .BurgerMenu .icon button span.is_active:nth-child(1) {
          top : 50%;
          transform : translateY(-50%) rotate(135deg);
        }
        .BurgerMenu .icon button span.is_active:nth-child(2) {
          transform : translate(50%, -50%);
          opacity : 0;
        }
        .BurgerMenu .icon button span.is_active:nth-child(3) {
          top : 50%;
          transform : translateY(-50%) rotate(-135deg);
        }
        /* ナビゲーション領域 */
        .BurgerMenu nav {
          display : none;
        }
        .BurgerMenu nav.is_active {
          display : block;
          margin : 0 0 0 auto;
          font-size : 1rem;
          position : absolute;
          top : calc(var(--iconSize) * 1.8);
          right : 0;
          width : calc(100% * var(--navWidth));
          height : var(--iconSize);
          z-index : var(--maxIndex);
        }
        .BurgerMenu nav ul {
          margin : 0rem 0rem 1rem 0rem;
          padding : 0rem 0rem 0rem 0rem;
          background-color : var(--back);
        }
        .BurgerMenu nav ul ul { /* 2階層以降のulにのみ適用 */
          display : none;
        }
        .BurgerMenu nav ul ul.is_open {
          display : block;
          border-top : solid 0.2rem var(--fore);
          border-left : solid 0.7rem var(--fore);
        }
        .BurgerMenu nav li {
          margin : 0.6rem 0rem 0.3rem 0.5rem;
          padding : 0.5rem 0rem 0rem 0rem;
          list-style : none;
          background-color : var(--back);
        }
        .BurgerMenu nav li a {
          color : var(--text);
          text-decoration : none;
          font-size: 1.5rem;
        },
        /* 背景 */
        .BurgerMenu .back {
          display : none;
        }
        .BurgerMenu .back.is_active {
          display : block;
          position : absolute;
          top : 0;
          right : 0;
          width : 100vw;
          height : 100vh;
          z-index : calc(var(--maxIndex) - 1);
          background : rgba(100,100,100,0.8);
        }
      `;
      v.default.toggle = () => {  // ナビゲーション領域の表示/非表示切り替え
        document.querySelector(`.${this.constructor.name} nav`).classList.toggle('is_active');
        document.querySelector(`.${this.constructor.name} .back`).classList.toggle('is_active');
        document.querySelectorAll(`.${this.constructor.name} .icon button span`)
        .forEach(x => x.classList.toggle('is_active'));        
      };
      v.default.showChildren = (event) => { // ブランチの下位階層メニュー表示/非表示切り替え
        event.target.parentNode.querySelector('ul').classList.toggle('is_open');
        let m = event.target.innerText.match(/^([▶️▼])(.+)/);
        const text = ((m[1] === '▼') ? '▶️' : '▼') + m[2];
        event.target.innerText = text;  
      };

      v.step = 2; // 引数と既定値から設定値のオブジェクトを作成
      v.arg = mergeDeeply(arg,v.default);
      if( v.arg instanceof Error ) throw v.arg;

      v.step = 3; // メンバに設定値をコピー
      for( v.x in v.arg ) this[v.x] = v.arg[v.x];

      v.step = 4; // wrapperが文字列(CSSセレクタ)ならHTMLElementに変更
      if( typeof this.wrapper === 'string' ){
        this.wrapper = document.querySelector(this.wrapper);
      }
      v.step = 5; // BurgerMenu専用CSSが未定義なら追加
      if( !document.querySelector(`style[name="${this.constructor.name}"]`) ){
        v.styleTag = document.createElement('style');
        v.styleTag.setAttribute('name',this.constructor.name);
        v.styleTag.textContent = this.css;
        document.head.appendChild(v.styleTag);
      }
  
      v.step = 6; // 終了処理
      console.log(`${v.whois} normal end.`);
      return v.rv;
  
    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}`
      + `\n${e.message}`
      + `\narg=${stringify(arg)}`;  // 引数
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }
  
  /** data-BurgerMenu属性の文字列をオブジェクトに変換
   * BurgerMenu専用として、以下の制限は許容する
   * - メンバ名は英小文字に限定
   * - カンマは区切記号のみで、id,label,func,hrefの値(文字列)内には不存在
   * 
   * @param {string} arg - data-BurgerMenuにセットされた文字列
   * @returns {Object|null|Error} 引数がnullまたは空文字列ならnullを返す
   */
  #objectize(arg){
    const v = {whois:this.constructor.name+'.objectize',rv:{},step:0};
    console.log(`${v.whois} start.`);
    try {

      v.step = 1; // nullまたは空文字列にはnullを返す
      if( !arg || arg.length === 0 ) return null;

      v.step = 2; // カンマで分割
      v.p = arg.split(',');

      v.step = 3; // 各値をオブジェクト化
      for( v.i=0 ; v.i<v.p.length ; v.i++ ){
        v.m = v.p[v.i].match(/^([a-z]+):['"]?(.+?)['"]?$/);
        if( v.m ){
          v.rv[v.m[1]] = v.m[2];
        } else {
          throw new Error('data-BurgerMenuの設定値が不適切です\n'+arg);
        }
      }

      v.step = 4.1; // idの存否チェック
      if( !v.rv.hasOwnProperty('id') )
        throw new Error('data-BurgerMenuの設定値にはidが必須です\n'+arg);
      v.step = 4.2; // ラベル不在の場合はidをセット
      if( !v.rv.hasOwnProperty('label') )
        v.rv.label = v.rv.id;
      v.step = 4.3; // allowの既定値設定
      v.rv.allow = v.rv.hasOwnProperty('allow') ? Number(v.rv.allow) : this.allow;
      v.step = 4.4; // func,href両方有ればhrefを削除
      if( v.rv.hasOwnProperty('func') && v.rv.hasOwnProperty('href') )
        delete v.rv.href;
      v.step = 4.5; // from/toの既定値設定
      v.rv.from = v.rv.hasOwnProperty('from')
        ? new Date(v.rv.from).getTime() : 0;  // 1970/1/1(UTC)
      v.rv.to = v.rv.hasOwnProperty('to')
        ? new Date(v.rv.from).getTime() : 253402182000000; // 9999/12/31(UTC)

      v.step = 5; // 終了処理
      console.log(`${v.whois} normal end.`);
      return v.rv;
  
    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}`
      + `\n${e.message}\narg=${stringify(arg)}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }
  
  /** 親要素を走査してナビゲーションを作成
   * @param {HTMLElement} wrapper - body等の親要素。
   * @param {HTMLElement} navi - nav等のナビゲーション領域
   * @param {number} depth=0 - 階層の深さ
   * @returns {null|Error}
   */
  genNavi(wrapper=this.wrapper,navi=this.navi,depth=0){
    const v = {whois:this.constructor.name+'.genNavi',rv:null,step:0,now:Date.now()};
    console.log(`${v.whois} start.`);
    try {

      v.step = 1.1; // navi領域をクリア
      if( depth === 0 ) navi.innerHTML = '';
      v.step = 1.2; // auth毎にホームを変更する場合、変更
      if( this.homeForEachAuth !== null ){
        this.home = this.homeForEachAuth[this.auth];
      }

      // 子要素を順次走査し、data-BurgerMenuを持つ要素をnaviに追加
      for( v.i=0 ; v.i<wrapper.childElementCount ; v.i++ ){
        v.d = wrapper.children[v.i];

        // wrapper内のdata-BurgerMenu属性を持つ要素に対する処理
        v.step = 2.1; // data-BurgerMenuを持たない要素はスキップ
        v.attr = this.#objectize(v.d.getAttribute(`data-${this.constructor.name}`));
        if( v.attr instanceof Error ) throw v.attr;
        if( v.attr === null ) continue;

        v.step = 2.2; // screenクラスが無ければ追加
        v.class = v.d.className.match(/screen/);
        if( !v.class ) v.d.classList.add('screen'); 
        v.step = 2.3; // nameが無ければ追加
        v.name = v.d.getAttribute('name');
        if( !v.name ){
          v.name = v.attr.id;
          v.d.setAttribute('name',v.name);
        }

        // navi領域への追加が必要か、判断
        v.step = 3.1; // 実行権限がない機能・画面はnavi領域に追加しない
        if( (this.auth & v.attr.allow) === 0 ) continue;
        v.step = 3.2; // 有効期間外の場合はnavi領域に追加しない
        if( v.now < v.attr.from || v.attr.to < v.now ) continue;

        v.step = 4; // navi領域にul未設定なら追加
        if( navi.tagName !== 'UL' ){
          v.r = createElement({tag:'ul',attr:{class:this.constructor.name}},navi);
          if( v.r instanceof Error ) throw v.r;
          navi = v.r;
        }

        v.step = 5; // メニュー項目(li)の追加
        v.li = {tag:'li',children:[{
          tag:'a',
          text:v.attr.label,
          attr:{class:this.constructor.name,name:v.attr.id},
        }]};
        v.hasChild = false;
        if( v.attr.hasOwnProperty('func') ){
          v.step = 5.1; // 指定関数実行の場合
          Object.assign(v.li.children[0],{
            attr:{href:'#',name:v.attr.func},
            event:{click:(event)=>{
              this.toggle();  // メニューを閉じる
              this.func[event.target.name](event); // 指定関数の実行
              this.genNavi(); // メニュー再描画
            }},
          });
        } else if( v.attr.hasOwnProperty('href') ){
          v.step = 5.2; // 他サイトへの遷移指定の場合
          Object.assign(v.li.children[0].attr,{href:v.attr.href,target:'_blank'});
          Object.assign(v.li.children[0],{event:{click:this.toggle}}); // 遷移後メニューを閉じる
        } else {
          v.step = 5.3; // その他(=画面切替)の場合
          // 子孫メニューがあるか確認
          if( v.d.querySelector(`[data-${this.constructor.name}]`) ){
            v.step = 5.33; // 子孫メニューが存在する場合
            v.hasChild = true; // 再帰呼出用のフラグを立てる
            Object.assign(v.li.children[0],{
              // 初期がサブメニュー表示ならclassにis_openを追加
              attr:{class:(this.initialSubMenu ? 'is_open' : '')},
              // '▼'または'▶︎'をメニューの前につける
              text: (this.initialSubMenu ? '▶︎' : '▼') + v.li.children[0].text,
              event: {click:this.showChildren}
            });
          } else { // 子孫メニューが存在しない場合
            v.step = 5.33; // nameを指定して画面切替
            Object.assign(v.li.children[0],{
              event:{click:(event)=>{
                changeScreen(event.target.getAttribute('name'));
                this.toggle();
              }}
            });
          }
        }

        v.step = 5.4; // navi領域にliを追加
        v.r = createElement(v.li,navi);
        if( v.r instanceof Error ) throw v.r;

        v.step = 5.5; // 子要素にdata-BurgerMenuが存在する場合、再帰呼出
        if( v.hasChild ){
          v.r = this.genNavi(v.d,v.r,depth+1);
          if( v.r instanceof Error ) throw v.r;
        }
      }

      v.step = 6; // 終了処理
      console.log(`${v.whois} normal end.`);
      return v.rv;
  
    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }
}
/** SPA用のスクリーンの切り替え
 * 
 * - スクリーン(div)は`class="screen" name="xxx"`を指定
 * - 引数の`screenName`は上述のname属性
 * 
 * @param {string} screenName - スクリーン名
 * @returns {void}
 */
function changeScreen(screenName){
  const v = {whois:'changeScreen',rv:null,step:0};
  try {

    v.step = 1; // 全スクリーンを閉じる
    document.querySelectorAll('.screen').forEach(x => x.style.display = 'none');

    v.step = 2; // 対象スクリーンを取得
    v.screen = document.querySelector(`.screen[name="${screenName}"]`);
    if( !v.screen ) throw new Error(`${screenName}が見つかりません`);

    v.step = 3; // 祖先に遡ってスクリーンを表示
    v.i = 100; // 永久ループ防止用
    while( v.screen.tagName !== 'BODY' && v.i > 0){
      if( v.screen.tagName === 'DIV' ){
        v.screen.style.display = '';
      }
      v.screen = v.screen.parentNode;
      v.i--;
    }

    v.step = 4; // 見つからなければエラー
    if( v.i <= 0 ) throw new Error(`${screenName}が見つかりません`);

    v.step = 5; // 終了処理
    return v.rv;

  } catch(e) {
    e.message = `${v.whois} abnormal end at step.${v.step}`
    + `\n${e.message}`
    + `\nscreenName=${stringify(screenName)}`;  // 引数
    console.error(`${e.message}\nv=${stringify(v)}`);
    return e;
  }
}
/** HTMLElementを生成する
 * @param {CEDefObj|CEDefObj[]} arg - 生成するHTMLElementの定義
 * @param {HTMLElement|string} [parent=null] - 本関数内部で親要素への追加まで行う場合に指定
 * @returns {HTMLElement|Error}
 */
function createElement(arg,parent=null){
  const v = {whois:'BasePage.createElement',rv:[],step:0};
  //console.log(v.whois+' start.',arg);
  try {
    v.step = 1.1; // 引数を強制的に配列化
    v.isArr = Array.isArray(arg); // 引数が配列ならtrue。戻り値にも使用するので保存
    if( !v.isArr ) arg = [arg];
    v.step = 1.2; // 親要素の特定
    if( parent !== null ){
      v.parent = typeof parent === 'string' ? document.querySelector(parent) : parent;
    }


    for( v.i = 0 ; v.i<arg.length ; v.i++ ){
      v.step = 2; // 既定値の設定
      v.def = {tag: 'div',attr: {},style:{},event:{},text: '',html:'',children:[],name:''};
      Object.assign(v.def,(typeof arg[v.i] === 'string' ? {tag:arg} : arg[v.i]))

      v.step = 3; // HTMLElementを生成、v.objとする
      v.obj = document.createElement(v.def.tag);

      v.step = 4; // HTMLElementの属性を定義
      for( v.j in v.def.attr ){
        v.obj.setAttribute(v.j,v.x = v.def.attr[v.j]);
      }

      v.step = 5; // 論理属性を定義(ex.checked)
      for( v.j in v.def.logical ){
        if( v.def.logical[v.j] ){
          v.obj.setAttribute(v.j,v.def.logical[v.j]);
        }
      }

      v.step = 6; // style属性の定義
      for( v.j in v.def.style ){
        if( v.j.match(/^\-\-/) ){ // CSS変数
          v.obj.style.setProperty(v.j,v.def.style[v.j]);
        } else {
          v.obj.style[v.j] = v.def.style[v.j];
        }
      }

      v.step = 7; // イベントの定義
      for( v.j in v.def.event ){
        v.obj.addEventListener(v.j,v.def.event[v.j],false);
      }

      v.step = 8; // 内部文字列(html or text)
      if( v.def.html.length > 0 ){
        v.obj.innerHTML = v.def.html;
      } else {
        // textareaの場合はvalueに、それ以外はinnerTextに内部文字列(text)をセット
        v.obj[v.def.tag.toLowerCase()==='textarea'?'value':'innerText'] = v.def.text;
      }

      v.step = 9; // 子要素の追加(parentは指定しない)
      for( v.j=0 ; v.j<v.def.children.length ; v.j++ ){
        v.obj.appendChild(this.createElement(v.def.children[v.j]));
      }

      v.step = 10; // 戻り値への登録
      v.rv.push(v.obj);

      v.step = 11; // 親要素への追加
      if( parent !== null ){
        v.parent.appendChild(v.obj);
      }

      v.step = 12; // メンバとして、また切替画面として登録
      if( v.def.name.length > 0 ){
        this[v.def.name] = v.obj;
        this.screenList[v.def.name] = v.obj;
      }
    }

    v.step = 12; // 配列で渡されたら配列で、オブジェクトならオブジェクトを返す
    v.rv = v.isArr ? v.rv : v.rv[0];
    //console.log(v.whois+' normal end.\n',v.rv);
    return v.rv;

  } catch(e){
    console.error(v.whois+' abnormal end(step.'+v.step+').',e,v);
    return e;
  }
}
/** 長さ・文字種指定に基づき、パスワードを生成
 * 
 * @param {number} [len=16] - パスワードの長さ
 * @param {Object} opt 
 * @param {boolean} [opt.lower=true] - 英小文字を使うならtrue
 * @param {boolean} [opt.upper=true] - 英大文字を使うならtrue
 * @param {boolean} [opt.symbol=true] - 記号を使うならtrue
 * @param {boolean} [opt.numeric=true] - 数字を使うならtrue
 * @returns {string}
 */
function createPassword(len=16,opt={lower:true,upper:true,symbol:true,numeric:true}){
  const v = {
    whois: 'createPassword',
    lower: 'abcdefghijklmnopqrstuvwxyz',
    upper: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
    symbol: '!#$%&()=~|@[];:+-*<>?_>.,',
    numeric: '0123456789',
    base: '',
    rv: '',
  }
  try {
    Object.keys(opt).forEach(x => {
      if( opt[x] ) v.base += v[x];
    });
    for( v.i=0 ; v.i<len ; v.i++ ){
      v.rv += v.base.charAt(Math.floor(Math.random() * v.base.length));
    }
  } catch(e) {
    console.error(v.whois+' abnormal end.\n'+e.stack+'\n'+JSON.stringify(v));
    v.rv = e;
  } finally {
    return v.rv;
  }
}
class encryptedQuery {

  /** @constructor
   * @param {Object} arg
   * === client/server両方で使用するパラメータ ==================
   * @param {boolean} arg.isClient=true - 動作環境。true:クライアント側、false:サーバ側
   * @param {string} arg.storageKey - DocumentProperties/sessionStorageのキー文字列
   * @param {string} arg.pUP='x' - 平文送信時のURLクエリパラメータの変数名(Plain URL Parameter)
   * @param {string} arg.eUP='y' - 暗号文〃(encrypted URL Parameter)
   * @param {number} arg.expire=172800000 - クライアント側鍵の有効期間。既定値48時間
   * @param {number} [arg.bits=1024] - クライアント側で鍵ペアを生成する場合の鍵長。既定値はconfig.jsで設定
   * === clientでのみ使用するパラメータ ==================
   * @param {string} arg.url - 問合せ先(server=WebAPI)のURL
   * @param {number|string} arg.clientId - クライアントのID。例：受付番号(entryNo)
   * === serverでのみ使用するパラメータ ==================
   * @param {SingleTable} arg.master - サーバ側でユーザ情報を保持するシート
   * @param {string} arg.IDcol - 当該シート上でのユーザ側を特定する欄名。ex.'entryNo'
   * @param {string} arg.CPcol - 当該シート上でユーザ側公開鍵を保持する欄名。ex.'CPkey'
   * @param {string} arg.upv - URLクエリパラメータ文字列。URL Parameter Variable
   * @param {number} arg.passcodeValidityPeriod=600000 - パスコードの有効期間。ミリ秒、既定値10分
   * @returns 
   * 
   */
  constructor(arg){
    const v = {whois:this.constructor.name+'.constructor',step:0,rv:null};
    console.log(`${v.whois} start.\narg=${stringify(arg)}`);
    try {

      (()=>{  v.step = 1; // 事前準備

        v.step = 1; // 環境変数(メンバ)の設定
        this.isClient = arg.hasOwnProperty('isClient') ? arg.isClient : true;
        if( arg.storageKey ){
          this.storageKey = arg.storageKey;
        } else {
          throw new Error(`${this.isClient?'sessionStorage':'DocumentProperties'}のキー文字列が指定されていません`);
        }
        this.pUP = arg.pUP || 'x';
        this.eUP = arg.eUP || 'y';
        this.expire = arg.expire || 172800000;
      })();

      if( this.isClient ){  v.step = 2; // 実行環境がクライアント側の場合の鍵ペア設定

        v.step = 2.1; // 必須パラメータの存否確認、既定値設定
        if( arg.url ) this.url = arg.url; else throw new Error('問合せ先(API)のURLが指定されていません');
        if( arg.clientId ) this.clientId = arg.clientId; else throw new Error('IDが指定されていません');

        v.step = 2.2; // 実行環境がクライアント側かつsessionStorageに保存されているなら取得
        this.conf = JSON.parse(sessionStorage.getItem(this.storageKey)) || {};

        v.step = 2.3; // 任意パラメータに既定値設定
        arg.bits = arg.bits || 1024;

        v.step = 2.3; // クライアント側鍵ペアの設定
        if( this.conf.CPkey ){
          v.step = 2.31; // クライアント側公開鍵が指定されている場合
          this.CSkey = RSAKey.parse(this.conf.CSkey);
          this.CPkey = this.conf.CPkey;
        } else {
          v.step = 2.32; // クライアント側公開鍵が未定の場合、鍵ペア未生成と看做して生成
          v.password = createPassword();
          this.CSkey = cryptico.generateRSAKey(v.password,(arg.bits));
          this.conf.CSkey = JSON.stringify(this.CSkey.toJSON());
          this.conf.CPkey = this.CPkey = cryptico.publicKeyString(this.CSkey);
          vlog(this,'CPkey');
          v.step = 2.33; // 生成した鍵ペアをsessionStorageに保存
          sessionStorage.setItem(this.storageKey,JSON.stringify(this.conf));
        }
        vlog(v,'password');
        vlog(this.conf,'CPkey');

        v.step = 2.4; // サーバ側公開鍵を取得済なら設定
        this.SPkey = this.conf.SPkey || null;

      } else {  v.step = 3; // 実行環境がサーバ側の場合の鍵ペア設定

        v.step = 3.1; // 必須パラメータの存否確認、既定値設定
        if( arg.master ) this.master = arg.master; else throw new Error('master is not defined.');
        if( arg.IDcol ) this.IDcol = arg.IDcol; else throw new Error('IDcol is not defined.');
        if( arg.CPcol ) this.CPcol = arg.CPcol; else throw new Error('CPcol is not defined.');
        this.passcodeValidityPeriod = this.passcodeValidityPeriod || 600000;

        v.step = 3.2; // 実行環境がサーバ側(GAS)かつDocumentPropertiesに保存されているなら取得
        this.conf = JSON.parse(PropertiesService.getDocumentProperties().getProperty(arg.storageKey));

        v.step = 3.3; // サーバ側鍵ペアの設定
        if( this.conf.SPkey ){
          // サーバ側公開鍵が作成済の場合
          this.SSkey = RSAKey.parse(this.conf.SSkey);
          this.SPkey = this.conf.SPkey;
        } else {
          // サーバ側公開鍵が未定の場合、鍵ペア未生成と看做して生成
          v.password = createPassword();
          this.SSkey = cryptico.generateRSAKey(v.password,(arg.bits || 1024));
          this.conf.SSkey = this.SSkey.toJSON();
          this.conf.SPkey = this.SPkey = cryptico.publicKeyString(this.SSkey);
          // 生成した鍵ペアをDocumentPropertiesに保存
          PropertiesService.getDocumentProperties().setProperty(this.storageKey,JSON.stringify(v.prop));
        }
      }

      v.step = 9; // 終了処理
      console.log(`${v.whois} normal end.`);

    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }

  /** request: クライアント->サーバ側への処理要求
   * 
   * @param {string|Object} arg - サーバ側で分岐処理を行うコールバック関数に渡す引数
   * @returns 
   */
  async request(arg=this.CPkey){
    const v = {whois:this.constructor.name+'.request',step:0,rv:null};
    console.log(`${v.whois} start.\narg(${whichType(arg)})=${stringify(arg)}`);
    try {

      // -------------------------------------------------
      // step.1 : 問合せ先URL(WebAPI+param)を作成
      // -------------------------------------------------

      v.step = 1.1; // 平文か暗号文か判定。サーバ側公開鍵取得済なら暗号文とする。
      v.isPlain = this.SPkey === null ? true : false;
      vlog(v,'isPlain');

      v.step = 1.2; // responseで署名検証のためにIDが必要なので付加し、JSON化
      v.json = JSON.stringify({id:this.clientId,arg:arg});
      vlog(v,'json');

      v.step = 1.3; // base64化
      v.b64 = await this.encB64(v.json);
      vlog(v,'b64');

      v.step = 1.4; // 暗号化
      if( v.isPlain ){
        v.str = v.b64;
      } else {
        v.enc = cryptico.encrypt(v.b64,this.SPkey,this.CSkey);
        vlog(v,'enc');
        if( v.enc.status !== 'success' ) throw new Error('encrypt failed.');
        v.str = v.enc.cipher;
      }

      v.step = 1.5; // URLセーフ化
      v.param = encodeURIComponent(v.str);
      vlog(v,'param');

      v.step = 1.6; // WebAPI+paramでURL作成
      v.url = `${this.url}?${v.isPlain ? this.pUP : this.eUP}=${v.param}`;
      vlog(v,'url');


      // -------------------------------------------------
      // step.2 : サーバ側に問合せ実行、結果検証
      // -------------------------------------------------

      v.step = 2.1; // 問合せの実行、ネットワークエラーなら弾く
      v.r = await fetch(v.url,{
        method: 'GET',
        headers: {
          "Accept": "application/json",
          "Content-Type": "text/plain",
        }
      });
      vlog(v,'r');
      if( !v.r.ok ) throw new Error(`[fetch error] status=${v.r.status}`);

      v.step = 2.2; // オブジェクト化
      v.obj = await v.r.json();
      vlog(v,'obj');

      v.step = 2.3; // 分岐先関数では無く、response()で起きたエラーの場合はthrow
      // ※分岐先関数でのエラーは本関数(response)の戻り値として本関数呼出元に返す
      if( v.obj.isOK === false ){
        throw new Error(v.obj.message);
      }

      v.step = 2.4;
      v.res = v.obj.rv;
      vlog(v,'res');


      // -------------------------------------------------
      // step.3 : 呼出元への戻り値の作成(結果の復号、署名検証)
      // -------------------------------------------------

      v.step = 3.1; // decrypt
      v.dec = cryptico.decrypt(v.res,this.CSkey);
      if( v.dec.status !== 'success' ){
        throw new Error(`decrypt failed.\n${stringify(v.dec)}`);
      }

      v.step = 3.2; // 署名検証、SPkeyが無ければ保存
      if( v.dec.publicKeyString !== this.SPkey ){
        if( this.SPkey === null ){
          this.conf.SPkey = this.SPkey = v.dec.publicKeyString;
          // sessionStorageに保存
          sessionStorage.setItem(this.storageKey,JSON.stringify(this.conf));
        } else {
          throw new Error('サーバ側の署名が不正です');
        }
      }

      v.step = 3.3; // base64 -> JSON
      v.json = await this.decB64(v.dec.plaintext);

      v.step = 3.4; // JSON -> Object
      v.rv = this.objectizeJSON(v.json);
      if( v.rv === null ){
        throw new Error(`invalid JSON\n${stringify(v.json)}`);
      }


      v.step = 9; // 終了処理
      console.log(`${v.whois} normal end.\nv.rv=${stringify(v.rv)}`);
      return v.rv;

    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }

  /** response: サーバ側処理、結果通知
   * 
   * @param {Object} arg - URLクエリ文字列のオブジェクト(e.parameter)
   * @param {*} callback - 分岐処理を行うコールバック関数。asyncで定義のこと。
   * @returns {Object}
   * 
   * - ContentService.createTextOutput()はdoGetで行うため、定義不要
   * 
   * - 戻り値のデータ型
   *   - isOK {boolean} true:正常終了、false:異常終了
   *   - message {string} エラーメッセージ(平文)
   *   - rv {Object} 署名＋暗号化された、分岐先関数の戻り値(JSON)。ex.`{status:-1}`
   */
  response(arg,callback){
    const v = {whois:this.constructor.name+'.response',step:0,rv:null};
    console.log(`${v.whois} start.\narg(${whichType(arg)})=${stringify(arg)}`);
    try {

      // -------------------------------------------------
      // step.1 : 分岐用関数に渡す引数v.argを作成
      // -------------------------------------------------

      v.step = 1.1; // 引数(e.parameter)が平文か暗号文か判定
      v.keys = Object.keys(arg);
      if( v.keys.length === 1 && v.keys.indexOf(this.pUP) >= 0 ){
        v.isPlain = true;
        v.str = arg[this.pUP];
      } else if( v.keys.length === 1 && v.keys.indexOf(this.eUP) >= 0 ){
        v.isPlain = false;
        v.str = arg[this.eUP];
      } else {
        throw new Error('Invalid URL query parameter');
      }
      vlog(v,['isPlain','str']);

      v.step = 1.2;  // URLセーフ解除
      v.cipher = decodeURIComponent(v.str);
      vlog(v,'cipher');

      v.step = 1.3;  // 暗号文なら復号
      if( v.isPlain ){
        v.b64 = v.cipher;
      } else {
        v.dec = cryptico.decrypt(v.cipher,this.SSkey);
        if( v.dec.status === 'success' ) v.b64 = v.dec.plaintext;
        else throw new Error(`decrypt failed.\n${stringify(v.dec)}`);
      }
      vlog(v,'b64');

      v.step = 1.4;  // base64解除
      v.json = this.decB64(v.b64);
      vlog(v,'json');

      v.step = 1.5;  // Object化
      v.obj = JSON.parse(v.json);
      vlog(v,'obj');

      v.step = 1.6;  // ユーザ情報を取得
      v.user = this.master.data.find(x => x[this.IDcol] == v.obj.id);
      if( !v.user )
        throw new Error(`対象が見つかりません(ID=${arg[this.upv]}[${whichType(arg[this.upv])}])`);
      vlog(v,'user');

      v.step = 1.7;  // 暗号文なら署名検証
      // 尚v.user.CPkeyおよびシートへの保存はauth1で実施、この時点での変更は不可。
      // ∵ masterは同一Objectなので、ここで変更すると「変更点無し」と解釈されupdateされない。
      if( v.isPlain === false && v.dec.publicKeyString !== v.user.CPkey ){
        throw new Error(`unmatch CPkey.\ndec.CPkey=${v.dec.publicKeyString}\nregistrated=${v.user.CPkey}`);
      }

      v.step = 1.8;  // 分岐用関数に渡す引数をv.argに設定
      // @param {Object} arg
      // @param {Boolean} arg.isPlain - true:平文、false:暗号文
      // @param {SingleTable} arg.master - ユーザ情報のシートオブジェクト
      // @param {Object.<string,any>} arg.user - master内の該当ユーザの情報
      // @param {number|string} arg.id - ユーザを特定する値
      // @param {Object} arg.arg - encryptedQuery.request()に渡された、分岐先関数の引数
      // @param {number} arg.expire - クライアント側鍵の有効期間。既定値48時間
      v.arg = {
        isPlain: v.isPlain,
        master: this.master,
        user: v.user,
        id: v.obj.id,
        arg: v.obj.arg,
        expire: this.expire,
      }
      vlog(v,'arg');


      // -------------------------------------------------
      v.step = 2; // 分岐用関数の呼び出し
      // -------------------------------------------------
      v.r = callback(v.arg);
      vlog(v,'r');


      // -------------------------------------------------
      // step.3 : 呼出元への戻り値の作成(結果への署名・暗号化)
      // -------------------------------------------------
      v.step = 3.1; // 分岐先関数の戻り値(Object) -> JSON
      v.json = JSON.stringify(v.r);
      vlog(v,'json');

      v.step = 3.2; // JSON -> base64
      v.b64 = this.encB64(v.json);
      vlog(v,'b64');

      v.step = 3.3; // base64 -> encrypt
      v.enc = cryptico.encrypt(v.b64,v.user.CPkey,this.SSkey);  // 署名あり
      if( v.enc.status !== 'success' ){
        throw new Error(`encrypt failed.\n${stringify(v.enc)}`);
      }

      v.step = 3.4; // 結果オブジェクトの作成
      v.rv = {isOK:true,rv:v.enc.cipher};

      v.step = 9; // 終了処理
      console.log(`${v.whois} normal end.\nv.rv(${whichType(v.rv)})=${stringify(v.rv)}`);

    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      v.rv = {isOK:false,message:e.message};
    } finally {
      return v.rv;
    }
  }

  /** encB64: 日本語文字列を含め、base64にエンコード
   * @param {string} parts - 変換する日本語文字列
   * @returns {string} base64エンコード文字列
   * 
   * - Qiita [JavaScriptでBase64エンコード・デコード](https://qiita.com/i15fujimura1s/items/6fa5d16b1e53f04f3b06)
   * - Zenn [URLセーフなBase64エンコーディングとデコーディング](https://zenn.dev/jusanz/articles/d6cec091d45657)
   * 
   * @example
   * 
   * ```
   * v.str = 'これはテスト用文字列です';
   * v.enc = await base64Encode(v.str);
   * v.dec = await base64Decode(v.enc);
   * console.log(`str=${v.str}\nenc=${v.enc}\ndec=${v.dec}`);
   * ```
   */
  encB64(text){
    const cl = async (...parts) => {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => {
          const offset = reader.result.indexOf(",") + 1;
          resolve(reader.result.slice(offset));
        };
        reader.readAsDataURL(new Blob(parts));
      });
    };
    const sv = text => Utilities.base64Encode(text, Utilities.Charset.UTF_8);

    return this.isClient ? cl(text) : sv(text);
  }

  /** decB64: base64を日本語文字列にデコード
   * @param {string} text - base64文字列
   * @param {string} charset='UTF-8'
   * @returns {string} 復号された日本語文字列
   * 
   * - Qiita [JavaScriptでBase64エンコード・デコード](https://qiita.com/i15fujimura1s/items/6fa5d16b1e53f04f3b06)
   * 
   * @example
   * 
   * ```
   * v.str = 'これはテスト用文字列です';
   * v.enc = await base64Encode(v.str);
   * v.dec = await base64Decode(v.enc);
   * console.log(`str=${v.str}\nenc=${v.enc}\ndec=${v.dec}`);
   * ```
  async base64Decode(text, charset='UTF-8') {
    return fetch(`data:text/plain;charset=${charset};base64,` + text)
    .then(response => response.text());
  }
   */
  decB64(text, charset='UTF-8') {
    const cl = (text, charset='UTF-8') => {
      return fetch(`data:text/plain;charset=${charset};base64,` + text)
      .then(response => response.text());
    };
    const sv = text => Utilities.newBlob(Utilities.base64Decode(text, Utilities.Charset.UTF_8)).getDataAsString();

    return this.isClient ? cl(text) : sv(text);
  }

  /** objectizeJSON: 文字列がJSONか判定、parse結果かnullを返す
   * 
   * @param {string} arg - 文字列
   * @returns {Object|null} JSON文字列だったらparse結果、非JSONならnull
   */
  objectizeJSON(arg){try{return JSON.parse(arg)}catch{return null}};

}
/**
 * @classdesc 待機画面を表示する
 */
class LoadingIcon {
  /**
   * @constructor
   * @param {Object} [arg={}] - オプション
   * @param {HTMLElement} [arg.pattern='theSpinner23'] - デザインパターン(CSSのクラス名)
   *
   * - [CSS Loaders](https://css-loaders.com/bars/)
   */
  constructor(arg={}){
    const v = {whois:this.constructor.name+'.constructor',rv:true,step:0,
      css: { theSpinner23: `
        dialog.LoadingIcon {
          margin: auto;
          width: 400px; /* .loader width * 2 */
          aspect-ratio: 1;
          position: relative;
          outline: none;
          border: none;
        }
        dialog.LoadingIcon::backdrop {background:#fff}
        dialog.LoadingIcon > div {
          position: absolute;
          top: 50%;
          left: 50%;
          margin: -100px 0 0 -100px;
        }

        /* HTML: <div class="loader"></div> */
        .loader {
          width: 200px;   /* ここは修正 */
          aspect-ratio: 1;
          display: grid;
          border-radius: 50%;
          background:
            linear-gradient(0deg ,rgb(0 0 0/50%) 30%,#0000 0 70%,rgb(0 0 0/100%) 0) 50%/8% 100%,
            linear-gradient(90deg,rgb(0 0 0/25%) 30%,#0000 0 70%,rgb(0 0 0/75% ) 0) 50%/100% 8%;
          background-repeat: no-repeat;
          animation: l23 1s infinite steps(12);
        }
        .loader::before,
        .loader::after {
          content: "";
          grid-area: 1/1;
          border-radius: 50%;
          background: inherit;
          opacity: 0.915;
          transform: rotate(30deg);
        }
        .loader::after {
          opacity: 0.83;
          transform: rotate(60deg);
        }
        @keyframes l23 {
          100% {transform: rotate(1turn)}
        }
      `},
    };
    console.log(`${v.whois} start.\narg=${stringify(arg)}`);
  try {

      v.step = 1; // 事前準備：argの既定値設定
      if( !arg.hasOwnProperty('pattern') ) arg.pattern = 'theSpinner23';

      v.step = 2; // 待機画面要素の準備
      this.screen = document.querySelector('.'+this.constructor.name);
      if( this.screen === null ){
        this.screen = createElement({
          tag:'dialog',
          attr:{class:this.constructor.name},
          children:[{attr:{class:'loader '+arg.pattern}}],
        },'body');
        if( this.screen instanceof Error ) throw this.screen;
      }

      v.step = 3; // styleの準備
      if( document.querySelector(`style[name="${this.constructor.name}_${arg.pattern}"]`) === null ){
        v.r = createElement({
          tag: 'style',
          attr: {type:'text/css',name:`${this.constructor.name}_${arg.pattern}"]`},
          text: v.css[arg.pattern].replaceAll(/\n/g,'').replaceAll(/\s+/g,' '),
        },'head');
      }

      v.step = 9; // 終了処理
      this.hide();
      console.log(`${v.whois} normal end.\nv.rv=${stringify(v.rv)}`);
      return v.rv;
  
    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }

  /** 待機画面を表示する */
  show = () => this.screen.showModal();

  /** 待機画面を隠蔽する */
  hide = () => this.screen.close();
}
/** 渡された変数内のオブジェクト・配列を再帰的にマージ
 * - pri,subともデータ型は不問。次項のデシジョンテーブルに基づき、結果を返す
 *
 * @param {any} pri - 優先される変数(priority)
 * @param {any} sub - 劣後する変数(subordinary)
 * @param {Object} opt - オプション
 * @returns {any|Error}
 *
 * #### デシジョンテーブル
 *
 * | 優先(pri) | 劣後(sub) | 結果 | 備考 |
 * | :--: | :--: | :--: | :-- |
 * |  A  |  -  |  A  | 優先(A)のみ存在するメンバはそのまま |
 * |  A  |  B  |  A  | |
 * |  A  | [B] |  A  | |
 * |  A  | {B} |  A  | |
 * | [A] |  -  | [A] | |
 * | [A] |  B  | [A] | |
 * | [A] | [B] | [X] | 配列はopt.arrayによる |
 * | [A] | {B} | [A] | |
 * | {A} |  -  | {A} | |
 * | {A} |  B  | {A} | |
 * | {A} | [B] | {A} | |
 * | {A} | {B} | {A+B} | オブジェクトも置換ではなく結合する |
 * |  -  |  -  |  -  | |
 * |  -  |  B  |  B  | |
 * |  -  | [B] | [B] | |
 * |  -  | {B} | {B} | |
 *
 * #### opt.array : pri,sub双方配列の場合の処理方法を指定
 *
 * 例 pri:[1,2,{x:'a'},{a:10,b:20}], sub:[1,3,{x:'a'},{a:30,c:40}]
 *
 * - pri(priority): 単純にpriをセット。subは全て廃棄 ⇒ [1,2,{x:'a'},{a:10,b:20}]
 * - add: 値の重複に拘わらず、pri+subを返す ⇒ [1,2,{x:'a'},{a:10,b:20},1,3,{x:'a'},{a:30,c:40}]
 * - set(既定値): priに無いsubの要素をpriに追加 ⇒ [1,2,3,{x:'a'},{x:'a'},{a:10,b:20},{a:30,c:40}]
 *   ※`{x:'a'}`は別オブジェクトなので、重複排除されない事に注意。関数、Date等のオブジェクトも同様。
 * - str(strict): priに無いsubの要素をpriに追加。setと異なり、内容が同値なら重複排除<br>
 *   ⇒ [1,2,3,{x:'a'},{a:10,b:20},{a:30,c:40}]
 * - cmp(未実装): pri[n]とsub[n]を比較(comparison)。原則pri優先だが、例外として両方がObj or Arrならマージ<br>
 *   ⇒ [1,2,{x:'a'},{a:10,b:20,c:40}]
 */
function mergeDeeply(pri,sub,opt={}){
  const v = {whois:'mergeDeeply',rv:null,step:0,
    isObj: arg => arg && String(Object.prototype.toString.call(arg).slice(8,-1)) === 'Object',
    isArr: arg => arg && Array.isArray(arg),
  };
  //console.log(`${v.whois} start.`+`\npri=${stringify(pri)}`+`\nsub=${stringify(sub)}`+`\nopt=${stringify(opt)}`);
  try {

    v.step = 1; // 既定値の設定
    if( !opt.hasOwnProperty('array') ) opt.array = 'set';

    if( v.isObj(pri) && v.isObj(sub) ){
      v.step = 2; // sub,pri共にハッシュの場合
      v.rv = {};
      v.step = 2.1; // 優先・劣後Obj両方のハッシュキー(文字列)を、重複しない形でv.keysに保存
      v.keys = new Set([...Object.keys(pri),...Object.keys(sub)]);
      for( v.key of v.keys ){
        if( pri.hasOwnProperty(v.key) && sub.hasOwnProperty(v.key) ){
          v.step = 2.2; // pri,sub両方がキーを持つ
          if( v.isObj(pri[v.key]) && v.isObj(sub[v.key]) || v.isArr(pri[v.key]) && v.isArr(sub[v.key]) ){
            v.step = 2.21; // 配列またはオブジェクトの場合は再帰呼出
            v.rv[v.key] = mergeDeeply(pri[v.key],sub[v.key],opt);
          } else {
            v.step = 2.22; // 配列でもオブジェクトでもない場合は優先変数の値をセット
            v.rv[v.key] = pri[v.key];
          }
        } else {
          v.step = 2.3; // pri,subいずれか片方しかキーを持っていない
          v.rv[v.key] = pri.hasOwnProperty(v.key) ? pri[v.key] : sub[v.key];
        }
      }
    } else if( v.isArr(pri) && v.isArr(sub) ){
      v.step = '3 '+opt.array; // sub,pri共に配列の場合
      switch( opt.array ){
        case 'pri':
          // pri: 単純にpriをセット。subは全て廃棄 ⇒ [1,2,{x:'a'},{a:10,b:20}]
          v.rv = pri;
          break;
        case 'add':
          // add: 値の重複に拘わらず、pri+subを返す ⇒ [1,2,{x:'a'},{a:10,b:20},1,3,{x:'a'},{a:30,c:40}]
          v.rv = [...pri, ...sub];
          break;
        case 'str':
          // str(strict): priに無いsubの要素をpriに追加。setと異なり、内容が同値なら重複排除<br>
          // ⇒ [1,2,3,{x:'a'},{a:10,b:20},{a:30,c:40}]
          v.rv = [];
          pri.forEach(x => v.rv.push(x));
          sub.forEach(s => {
            v.flag = false;
            pri.forEach(p => v.flag = v.flag || isEqual(s,p));
            if( v.flag === false ) v.rv.push(s);
          });
          break;
        default:
          // set(既定値): priに無いsubの要素をpriに追加 ⇒ [1,2,{x:'a'},{a:10,b:20},3,{x:'a'},{a:30,c:40}]
          v.rv = [...new Set([...pri,...sub])];
      }
    } else {
      v.step = 4; // subとpriのデータ型が異なる ⇒ priを優先してセット
      v.rv = whichType(pri,'Undefined') ? sub : pri;
      //console.log(`l.228 pri=${stringify(pri)}, sub=${stringify(sub)} -> rv=${stringify(v.rv)}`)
    }
    v.step = 5;
    //console.log(`${v.whois} normal end.`+`\npri=${stringify(pri)}`+`\nsub=${stringify(sub)}`+`\nopt=${stringify(opt)}`+`\nv.rv=${stringify(v.rv)}`)
    return v.rv;

  } catch(e) {
    e.message = `${v.whois} abnormal end at step.${v.step}`
    + `\n${e.message}`
    + `\npri=${JSON.stringify(pri)}`
    + `\nsub=${JSON.stringify(sub)}`
    + `\nopt=${JSON.stringify(opt)}`;
    console.error(`${e.message}\nv=${JSON.stringify(v)}`);
    return e;
  }
}
class Reception {

  /**
   * @param {Object} arg
   * @param {string} arg.wrapper - Receptionを展開する包摂要素のCSSセレクタ
   * @param {string[]} arg.header - シート上の項目名のリスト
   * @param {Object[]} arg.data - シート上のデータ。{項目名:値,..}
   * @param {Function|Arrow} arg.filter - 対象者の判定式。戻り値はboolean
   */
  constructor(arg){
    const v = {whois:this.constructor.name+'.constructor',step:0,rv:null};
    console.log(`${v.whois} start.\narg=${stringify(arg)}`);
    try {

      v.step = 1; // 既定値の設定、メンバ変数への保存
      this.wrapper = document.querySelector(arg.wrapper || '.Reception[name="wrapper"]');
        // {HTMLElement} Receptionを展開する包摂要素
      this.header = arg.header; // {string[]} シート上の項目名のリスト
      this.data = arg.data; // {Object[]} シート上のデータ。{項目名:値,..}
      this.filter = arg.filter; // {Function|Arrow} 対象者の判定式。戻り値はboolean

      v.step = 2; // スキャナ領域をメンバ変数にセット＋イベント定義
      this.scanner = this.wrapper.querySelector('[name=scanner]');
      this.keyword = this.wrapper.querySelector('[name="keyword"]');
      // 「検索」ボタンクリックでキーワードを所定の要素に埋め込む
      this.keyword.querySelector('button').addEventListener('click',e => {
        e.target.parentNode.querySelector('[name="val"]').innerText
        = e.target.parentNode.querySelector('input').value;
      });
      // 検索結果が複数時の候補者一覧表示画面
      this.dialog = this.scanner.querySelector('dialog');
      this.dialog.querySelector('button').addEventListener('click',()=>{
        this.dialog.close();
        v.entryNo = Number(this.dialog.querySelector('button').value);
        console.log(`l.568 entryNo(${whichType(v.entryNo)})=${v.entryNo}`);
        v.r = this.editParticipant(this.data.find(x => Number(x.entryNo) === v.entryNo));
        if( v.r instanceof Error ) throw v.r;
      });

      v.step = 3; // 申込情報詳細画面領域をメンバ変数にセット＋イベント定義
      this.detail = this.wrapper.querySelector('[name="detail"]');
      // 詳細画面のボタンクリック時(受付時、参加費等の入力後)の動作定義
      ['cancel','update','updall'].forEach(x =>
        this.detail.querySelector(`button[name="${x}"]`)
        .addEventListener('click',async e=>{await this.updateDetail(e)}));

      v.step = 9; // 終了処理
      console.log(`${v.whois} normal end.\nv.rv=${stringify(v.rv)}`);
      return v.rv;

    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }

  /** targeting: 受付番号を入力して該当者を特定、申込情報編集画面を呼び出す
   * @param {void}
   * @returns {null}
   */
  async targeting(){
    const v = {whois:this.constructor.name+'.targeting',step:0,rv:null,target:null};
    console.log(`${v.whois} start.`);
    try {

      v.step = 1; // 事前準備：スキャナ画面を表示、詳細画面を閉鎖
      this.scanner.style.display = 'grid';
      this.detail.style.display = 'none';
      this.scanner.querySelector('[name="keyword"] input').value = '';
      this.scanner.querySelector('[name="val"]').innerText = '';

      v.candidates = await (async ()=>{  v.step = 2; // 受付番号スキャン、キーワード入力
        v.cnt = 20; // 永久ループ防止用
        while( v.cnt > 0 ){  // 適切なキー(受付番号or氏名)が入力されるまでループ

          v.step = 2.1; // scanQRからキーを取得
          v.r = await scanQR('.Reception [name="camera"]',{field:()=>{
            return this.scanner.querySelector('[name="val"]').innerText}});
          if( v.r instanceof Error ) throw v.r;

          v.step = 2.2; // キーを基に該当者を抽出
          v.rv = this.data.filter(o => {return this.filter(o,v.r)});
          if( v.rv.length > 0 ){
            return v.rv;
          } else {  // 該当無しならメッセージ＋クリア後、再入力
            alert('該当無し');
            this.scanner.querySelector('[name="keyword"] input').value = '';
            this.scanner.querySelector('[name="val"]').innerText = '';
            v.cnt--;
          }
        }
      })();

      v.target = await (()=>{  v.step = 3; // 該当者の詳細画面呼び出し

        if( v.candidates.length === 1 ){
          v.step = 3.1; // 該当が一件のみ
          v.r = this.editParticipant(v.candidates[0]);
          if( v.r instanceof Error ) throw v.r;
        } else {
          v.step = 3.2; // 該当が複数 ⇒ ダイアログでリスト表示、選択
          v.candidates.sort((a,b)=>a['申込者カナ']<b['申込者カナ']).forEach(o => {
            createElement({
              attr: {name:o.entryNo},
              children:[{tag:'ruby',text:o['申込者氏名'],children:[{tag:'rt',text:o['申込者カナ']}]}],
              event: {click:e=>{
                // 選択された候補者に背景色を付け、受付番号をbutton.valueにセット
                this.dialog.querySelectorAll('div').forEach(x => x.classList.remove('act'));
                v.e = e.target.closest('div');
                v.e.classList.add('act');
                this.dialog.querySelector('button').value = v.e.getAttribute('name');
              }},
            },this.dialog.querySelector('[name="list"]'));
          });
          v.step = 3.3; // 最初の選択肢が選択された状態にしてダイアログ表示
          this.dialog.querySelector('button').value = v.candidates[0].entryNo;
          this.dialog.querySelector('[name="list"] [name]').classList.add('act');
          this.dialog.showModal();
        }
      })();

      v.step = 9; // 終了処理
      console.log(`${v.whois} normal end.\nv.rv=${stringify(v.rv)}`);
      return v.rv;

    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }

  /** editParticipant: 申込情報編集画面を表示
   * @param {Object.<string, any>} arg - 該当申込情報のオブジェクト
   * @returns {null}
   */
  editParticipant(arg){
    const v = {whois:this.constructor.name+'.editParticipant',step:0,rv:null};
    console.log(`${v.whois} start.\narg=${stringify(arg)}`);
    try {

      v.step = 1; // 事前準備
      // スキャナ画面を閉鎖、詳細画面表示
      this.scanner.style.display = 'none';
      this.detail.style.display = 'grid';
      // メモ欄のクリア
      this.detail.querySelector('textarea[name="memo"]').value = '';
      // 既定値の設定
      v.data = Object.assign({
        '緊急連絡先': '(未記入)',
        'ボランティア募集': '(不可)',
      },arg);
      // キャンセルの文言を修正
      v.data['キャンセル'] = v.data['キャンセル'] ? 'canceled' : '';

      v.step = 2; // 対象申込情報をdetail内の各要素に書き込み
      v.step = 2.1; // 非参加者情報をセット
      this.header.forEach(col => {
        if( col.indexOf('参加者0') < 0 || col.indexOf('fee0') < 0 ){
          // 必須項目をセット
          v.e = this.detail.querySelector(`[name="${col}"]`);
          if( v.e ){
            if( col === 'editURL' ){
              this.detail.querySelector('[name="editURL"] img').src
              = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data='
              + v.data.editURL;
            } else if( col === 'memo' ){
              if( v.data['memo'] )
                this.detail.querySelector('textarea').value = v.data['memo'];
            } else {
              v.e.innerText = v.data[col] ? v.data[col] : '';
            }
          }
        }
      });

      v.step = 2.2; // 参加者情報をセット
      for( v.i=1 ; v.i<=5 ; v.i++ ){
        if( !v.data[`参加者0${v.i}氏名`] ){
          v.step = 2.21; // 氏名未登録の参加者は空欄
          this.detail.querySelector(`tr[name="参加者0${v.i}"]`).innerHTML = '';
        } else {
          v.step = 2.22; // 氏名・カナ・所属のセット
          ['氏名','カナ','所属'].forEach(x => {
            v.col = `参加者0${v.i}${x}`;
            this.detail.querySelector(`[name="${v.col}"]`).innerHTML = v.data[v.col] ? v.data[v.col] : '';
          });

          v.step = 2.23; // 会費のセット
          v.col = `fee0${v.i}`;
          v.val = v.data[v.col] ? v.data[v.col] : '未収';
          this.detail.querySelector(`[name="${v.col}"][value="${v.val}"]`).checked = true;
        }
      }

      v.step = 9; // 終了処理
      console.log(`${v.whois} normal end.\nv.rv=${stringify(v.rv)}`);
      return v.rv;

    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }

  /** updateDetail: 詳細画面の入力内容をシートに反映
   * 要更新箇所はfee01〜05、memoのみ。
   * @param {string} arg - 動作内容。cancel || update || updall
   */
  async updateDetail(e){
    const v = {whois:this.constructor.name+'.updateDetail',step:0,rv:null,obj:{}};
    console.log(`${v.whois} start.`);
    try {

      v.func = e.target.getAttribute('name');

      // update or updall ⇒ 入力内容で更新
      if( v.func === 'update' || v.func === 'updall' ){
        // 受付番号を取得
        v.obj.entryNo = Number(this.detail.querySelector('[name="entryNo"]').innerText);
        // fee01〜05を取得
        for( v.i=1 ; v.i<6 ; v.i++ ){
          v.tr = this.detail.querySelector(`tr[name="参加者0${v.i}"]`);
          if( v.tr.innerHTML.length > 0 ){
            v.obj['fee0'+v.i] = v.func === 'updall' ? '既収' :
            this.detail.querySelector(`form[name="参加者0${v.i}会費"]`).elements['fee0'+v.i].value;
          }
        }
        // memoを取得
        v.memo = this.detail.querySelector('textarea[name="memo"]').value;
        if( v.memo.length > 0 ) v.obj.memo = v.memo;
        // 取得結果をシートに反映
        v.r = await doGAS('SingleTableServer','master','update',v.obj,{key:'entryNo',value:v.obj.entryNo});
        if( v.r instanceof Error ) throw v.r;
        // 確認ダイアログ表示
        alert('更新しました');
      }

      v.step = 9; // 終了処理
      v.r = await this.targeting(); // 受付番号入力画面を再度呼び出し
      if( v.r instanceof Error ) throw v.r;
      console.log(`${v.whois} normal end.\nv.rv=${stringify(v.rv)}`);
      return v.rv;

    } catch(e) {
      e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
      console.error(`${e.message}\nv=${stringify(v)}`);
      return e;
    }
  }
}
/** QRコードをスキャン
 * なお縦横いずれでも汎用的に使えるよう、撮像領域(ファインダ)は正方形とする
 * @param {string} parent - 親要素のCSSセレクタ
 * @param {Object} [opt={}] - オプション
 * @param {number} opt.size - ファインダ領域のサイズ
 * @param {number} opt.interval=300 - 撮像間隔。ミリ秒
 * @param {number} opt.max=90000 - 最大待機時間。単位：ミリ秒
 * @param {Function} opt.field - 入力欄を併用する場合、入力欄の値を返す関数
 * @returns {string} スキャンしたQRコードの文字列
 *
 * - Qiita [html＋javascriptだけで実装したシンプルなQRコードリーダー](https://qiita.com/murasuke/items/c16e4f15ac4436ed2744)
 * - [Promiseでsleep機能を作る](https://www.sejuku.net/blog/24629#index_id5)
 */
async function scanQR(parent,opt={}){
  const v = {whois:'scanQR',rv:null,
    max: opt.max || 90000, // 最大待機時間。単位：ミリ秒
    interval: opt.interval || 300, // 撮像間隔。ミリ秒
    minSize : opt.minSize || 640, // 最小撮像サイズ。px
    sleep: (sec) =>  // 指定時間待機
      {return new Promise(resolve => setTimeout(resolve,sec))},
  };
  console.log(`${v.whois} start.\nparent=${parent}\nopt=${stringify(opt)}`);
  try {

    v.step = 1; // 親要素のサイズ設定、取得
    // 親要素の幅を最大に、高さを幅に合わせる
    v.parent = document.querySelector(parent);
    v.parent.style.width = '100%';
    opt.size = opt.size || v.parent.clientWidth;
    v.szNum = opt.size < v.parent.clientWidth // 数値単位の撮像領域幅。ex.980
      ? opt.size : v.parent.clientWidth;
    v.szStr = v.parent.style.height = v.szNum + 'px'; // 文字列型の撮像領域幅。ex.980px

    v.step = 2; // video要素の生成
    v.video = v.parent.querySelector('video');
    if( !v.video ){
      v.video = createElement({tag:'video',style:{width:v.szStr,height:v.szStr}},v.parent);
      if( v.video instanceof Error ) throw v.video;
    }
    v.constraints = {
      audio: false, // 音声は使用しない
      video: {
        facingMode: 'environment',
        width: v.szNum,
        height: v.szNum,
      },
    };
    const stream = await navigator.mediaDevices.getUserMedia(v.constraints);
    v.video.srcObject = stream;
    v.video.play();

    v.step = 3; // canvas要素の生成
    const { width, height } = v.constraints.video;
    v.canvas = new OffscreenCanvas(width, height);
    const context = v.canvas.getContext('2d');

    v.step = 4; // 定期的なスキャン実行
    v.cnt = 0;
    do {
      context.drawImage(v.video, 0, 0, width, height);
      const imageData = context.getImageData(0, 0, width, height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      v.field = opt.field();  // 入力欄に入力されていれば!null
      if (code || v.field) {
        v.rv = v.field || code.data;
      } else {
        await v.sleep(v.interval);
        console.log(v.cnt);
        v.cnt += v.interval;
      }
    } while( v.rv === null && v.cnt < v.max );

    // 終了処理
    v.video.srcObject.getVideoTracks().forEach((track) => {
      track.stop();
    });

    console.log(v.whois+' normal end.\n'+v.rv);
    return v.rv;

  } catch(e) {
    e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
    console.error(`${e.message}\nv=${stringify(v)}`);
    return e;
  }
}
/** 関数他を含め、変数を文字列化
 * - JSON.stringifyでは文字列化されない関数、シンボル、undefinedも文字列化して表示
 * - 関数はtoString()で文字列化
 * - シンボルは`Symbol(xxx)`という文字列とする
 * - undefinedは'undefined'(文字列)とする
 *
 * @param {Object} variable - 文字列化対象変数
 * @param {Object|boolean} opt - booleanの場合、opt.addTypeの値とする
 * @param {boolean} opt.addType=false - 文字列化の際、元のデータ型を追記
 * @returns {string}
 * @example
 *
 * ```
 * console.log(`l.424 v.td=${stringify(v.td,true)}`)
 * ⇒ l.424 v.td={
 *   "children":[{
 *     "attr":{"class":"[String]th"}, // opt.addType=trueなら[データ型名]がつく
 *     "text":"[String]タグ"
 *   },{
 *     "attr":{"class":"[String]td"},
 *     "text":"[String]#md"
 *   }],
 *   "style":{"gridColumn":"[String]1/13"},
 *   "attr":{"name":"[String]tag"}
 * }
 * ```
 */
function stringify(variable,opt={addType:false}){
  const v = {whois:'stringify',rv:null,step:0};
  const conv = arg => {
    const w = {type:whichType(arg)};
    w.pre = opt.addType ? `[${w.type}]` : '';
    switch( w.type ){
      case 'Function': case 'Arrow': case 'Symbol':
        w.rv = w.pre + arg.toString(); break;
      case 'BigInt':
        w.rv = w.pre + parseInt(arg); break;
      case 'Undefined':
        w.rv = w.pre + 'undefined'; break;
      case 'Object':
        w.rv = {};
        for( w.i in arg ){
          // 自分自身(stringify)は出力対象外
          if( w.i === 'stringify' ) continue;
          w.rv[w.i] = conv(arg[w.i]);
        }
        break;
      case 'Array':
        w.rv = [];
        for( w.i=0 ; w.i<arg.length ; w.i++ ){
          w.rv[w.i] = conv(arg[w.i]);
        }
        break;
      default:
        w.rv = w.pre + arg;
    }
    return w.rv;
  };
  //console.log(`${v.whois} start.\nvariable=${variable}\nopt=${JSON.stringify(opt)}`);
  try {

    v.step = 1; // 事前準備
    if( typeof opt === 'boolean' ) opt={addType:opt};

    v.step = 2; // 終了処理
    //console.log(`${v.whois} normal end.`);
    return JSON.stringify(conv(variable));

  } catch(e) {
    e.message = `${v.whois} abnormal end at step.${v.step}`
    + `\n${e.message}`;
    console.error(`${e.message}\nv=${JSON.stringify(v)}`);
    return e;
  }
}
/** summaryTable: 集計表を作成
 * @param {Object} arg
 * @param {string} arg.wrapper - tableの包摂要素(div)を指定するCSSセレクタ
 * @param {Object[]} arg.data - 集計表の元となるデータ。1行1Objectの配列
 * @param {string[]} arg.cols - 横軸の項目名
 * @param {string[]} arg.rows - 縦軸の項目名
 * @param {string[]} arg.colsFormula - 横軸の集計項目の算式。但し加減に限る
 * @param {string[]} arg.rowsFormula - 縦軸の集計項目の算式
 * @param {function} arg.normalize - データを正規化する関数
 * @param {Object} arg.thead - ヘッダ部を作成するcreateElementオブジェクト
 * @param {Object} arg.tbody - ボディ部を作成するcreateElementオブジェクト。但し計数項目・導出項目は除く
 * 
 * - 空白行は想定しない(全てのセルが計数項目または導出項目の前提)
 * - Google Spread [表形式仕様・テストデータ](https://docs.google.com/spreadsheets/d/1fvCYOfp35LivbZlQHIhnGaujpCUeoI7u2qydFrMFem0/edit?gid=1400698249#gid=1400698249)
 * 
 * **normalizeの仕様**
 * 
 * - 引数：1行分のオブジェクト
 *   ex.`{"申込者の参加": "参加予定(宿泊なし)","宿泊、テント": "宿泊しない","参加者01所属": "1年生","参加者02所属": "2年生","参加者03所属": "2年生"}`
 * - 戻り値：1件毎に分割されたオブジェクトの配列。メンバはrow,colのみ、値はarg.rows/colsに存在する文字列
 *   ex.`[{row:"申込口数",col:"日帰り"},{row:"1年生",col:"日帰り"},{row:"2年生",col:"日帰り"},{row:"2年生",col:"日帰り"}]`
 */
function summaryTable(arg){
  const v = {whois:'summaryTable',step:0,rv:null,data:[]};
  console.log(`${v.whois} start.\narg=${stringify(arg)}`);
  try {

    v.step = 1; // データを正規化する
    arg.data.forEach(o => v.data.push(...arg.normalize(o)));
    vlog(v,'data');

    v.step = 2; // 計数項目の集計
    v.sql = 'select `row`,`col`,count(*) as `num` from ? group by `row`,`col`;';
    v.table = alasql(v.sql,[v.data]);
    vlog(v,'table');

    v.step = 3; // 横方向での導出項目の計算
    arg.colsFormula.forEach(formula => {
      v.step = 3.1;
      v.m = formula.match(/^(.+?)=(.+)$/);
      v.left = v.m[1];
      v.fm = [];
      v.cols = v.m[2].replaceAll(/([\+\-])/g,"\t$1").split('\t');
      v.cols.forEach(col => {
        v.m = col.match(/^([\+\-])(.+)$/);
        if( v.m ) v.fm.push({sign:v.m[1]==='+',name:v.m[2]});
        else v.fm.push({sign:true,name:col});
      });
      vlog(v,['m','cols','to','fm']);

      arg.rows.forEach(row => {
        v.step = 3.2; // 集計結果を格納するセルを特定、v.cellとする
        v.cell = v.table.find(x => x.row === row && x.col === v.left);
        if( v.cell === undefined ){
          v.cell = {row:row,col:v.left,num:0};
          v.table.push(v.cell);
        }

        v.step = 3.3; // 式に現れた項目毎に加減
        v.fm.forEach(col => {
          v.cell.num += ((v.table.find(x => x.row === row && x.col === col.name)
          || {num:0}).num) * (col.sign ? 1 : -1);
        });
        vlog(v,'cell');
      });
    });

    v.step = 4; // 縦方向での導出項目の計算
    arg.rowsFormula.forEach(formula => {
      v.step = 4.1;
      v.m = formula.match(/^(.+?)=(.+)$/);
      v.left = v.m[1];
      v.fm = [];
      v.rows = v.m[2].replaceAll(/([\+\-])/g,"\t$1").split('\t');
      v.rows.forEach(row => {
        v.m = row.match(/^([\+\-])(.+)$/);
        if( v.m ) v.fm.push({sign:v.m[1]==='+',name:v.m[2]});
        else v.fm.push({sign:true,name:row});
      });
      vlog(v,['m','rows','to','fm']);

      arg.cols.forEach(col => {
        v.step = 4.2; // 集計結果を格納するセルを特定、v.cellとする
        v.cell = v.table.find(x => x.row === v.left && x.col === col);
        if( v.cell === undefined ){
          v.cell = {row:v.left,col:col,num:0};
          v.table.push(v.cell);
        }

        v.step = 4.3; // 式に現れた項目毎に加減
        v.fm.forEach(row => {
          v.cell.num += ((v.table.find(x => x.row === row.name && x.col === col)
          || {num:0}).num) * (row.sign ? 1 : -1);
        });
        vlog(v,'cell');
      });
    });

    for( v.i=0 ; v.i<arg.tbody.length ; v.i++ ){
      v.step = 5.1; // 表要素の作成：行単位
      v.tr = arg.tbody[v.i].children;
      for( v.j=0 ; v.j<arg.cols.length ; v.j++ ){
        v.step = 5.2; // 列単位
        v.val = (v.table.find(x => x.row === arg.rows[v.i] && x.col === arg.cols[v.j]) || {num:0}).num;
        v.tr.push({tag:'td',text:v.val});
      }
      vlog(v,'tr')
    }


    v.step = 5.3; // 表の作成
    v.r = createElement({
      children:[
        {tag:'table',children:[
          {tag:'thead',children:arg.thead},
          {tag:'tbody',children:arg.tbody},
        ]}
    ]},document.querySelector(arg.wrapper));
    if( v.r instanceof Error ) throw v.r;

    v.step = 9; // 終了処理
    console.log(`${v.whois} normal end.\nv.rv=${stringify(v.rv)}`);
    return v.rv;

  } catch(e) {
    e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
    console.error(`${e.message}\nv=${stringify(v)}`);
    return e;
  }
}
/** vlog: デバッグ用コンソール出力
 * @param {Object} o - 出力対象Object
 * @param {string|string[]} m - メンバ名
 * @param {number|Object} l=null - 数値なら行番号、Objectならwhois,stepをメンバに持つ変数('v'を想定)
 * @returns {void}
 * 
 * - ver.1.1.0 2024/09/12
 *   - v以外の変数(ex.this)でもstep表示を可能に(lにObjectを追加)
 *   - 階層化オブジェクトメンバの指定を可能に(v.convの追加)
 */
const vlog = (o,m,l=null) => {
  // return; // デバッグ用。本番時はコメントを外す
  const v = {
    lType: whichType(l),  // 引数lのデータ型
    conv: (o,s) => {s.split('.').forEach(x => o = o[x]);return o},
  };

  switch( v.lType ){
    case 'Object': v.whois = l.whois; v.step = l.step; v.line = null; break;
    case 'Null'  : // Numberと同じ
    case 'Number': v.whois = o.whois; v.step = o.step; v.line = l; break;
  }
  v.msg = new Date().toLocaleTimeString()
    + (v.whois ? ` ${v.whois}` : '')
    + (v.step ? ` step.${v.step}` : '')
    + (v.line ? ` l.${v.line}` : '');

  if( whichType(m,'string') ) m = [m];
  m.forEach(str => {
    v.val = v.conv(o,str);
    v.msg += `\n${str}(${whichType(v.val)})=${stringify(v.val)}`
  });

  console.log(v.msg);
}
/** 変数の型を判定
 * 
 * - 引数"is"が指定された場合、判定対象が"is"と等しいかの真偽値を返す。
 *
 * @param {any} arg - 判定対象の変数
 * @param {string} [is] - 想定される型(型名の大文字小文字は意識不要)
 * @returns {string|boolean} - 型の名前。is指定有りなら判定対象が想定型かの真偽値
 *
 * @example
 * ```
 * let a = 10;
 * whichType(a);  // 'Number'
 * whichType(a,'string'); // false
 * ```
 *
 * <b>確認済戻り値一覧</b>
 *
 * オブジェクトは型名が返るので、限定列挙は困難。以下は確認済みの戻り値のみ記載。
 *
 * | 型名 | 戻り値 | 備考 |
 * | :-- | :-- | :-- |
 * | 文字列 | String |  |
 * | 数値 | Number |  |
 * | NaN | NaN |  |
 * | 長整数 | BigInt |  |
 * | 論理値 | Boolean |  |
 * | シンボル | Symbol |  |
 * | undefined | Undefined | 先頭大文字 |
 * | Null | Null |  |
 * | オブジェクト | Object |  |
 * | 配列 | Array |  |
 * | 関数 | Function |  |
 * | アロー関数 | Arrow |  |
 * | エラー | Error | RangeError等も'Error' |
 * | Date型 | Date |  |
 * | Promise型 | Promise |  |
 *
 * - Qiita [JavaScriptの型などの判定いろいろ](https://qiita.com/amamamaou/items/ef0b797156b324bb4ef3)
 *
 */
function whichType(arg,is){
  let rv = String(Object.prototype.toString.call(arg).slice(8,-1));
  switch(rv){
    case 'Number': if(Number.isNaN(arg)) rv = 'NaN'; break;
    case 'Function': if(!('prototype' in arg)) rv = 'Arrow'; break;
  }
  if( typeof is === 'string' ){
    return rv.toLowerCase() === is.toLowerCase();
  } else {
    return rv;
  }
}
</script>
<script type="text/javascript" title="onload">
window.addEventListener('DOMContentLoaded',async () => {
  const v = {whois:'DOMContentLoaded',rv:null,step:0};
  console.log(`${v.whois} start.`);
  try {

    (()=>{ v.step = 1;  // 事前準備

      v.step = 1.1; // 待機画面作成
      v.loading = new LoadingIcon();
      v.loading.show();

      v.step = 1.2; // リロードしたらsessionStorageを全てクリア
      sessionStorage.clear();

      v.step = 1.3; v.conf = // 設定情報(v.conf)の作成
{
  sys: {
    underDev: false,
    storageKey: 'config',
    staffML: 'skz-oyaji@googlegroups.com',
    adminMail: 'shimokitasho.oyaji@gmail.com',
    qrserver: 'https://api.qrserver.com/v1/create-qr-code/?data=',
    qrSize: '&size=200x200',
    upv: 'n',
    isClient: true,
    auth: {
      bits: 1024,
      maxTrial: 3,
      passcodeValidityPeriod: 600000,
      expire: 172800000,
      freezing: 3600000,
      authFlag: 2,
      passcodeDigit: 6
    }
  },
  publicSite: {
    title: '一般公開サイト',
    type: 'site',
    url: 'https://nakaone.github.io/public/camp2024/index.html',
    shortURL: 'https://tinyurl.com/2b9lymoc',
    qr: 'https://api.qrserver.com/v1/create-qr-code/?data=https://nakaone.github.io/public/camp2024/index.html'
  },
  staffSite: {
    title: 'スタッフ専用サイト',
    type: 'site',
    url: 'https://nakaone.github.io/public/camp2024/staff.html',
    shortURL: 'https://tinyurl.com/2aovhf8r',
    qr: 'https://api.qrserver.com/v1/create-qr-code/?data=https://nakaone.github.io/public/camp2024/staff.html'
  },
  master: {
    title: '「管理局」スプレッドシート',
    type: 'spread',
    spread: 'https://docs.google.com/spreadsheets/d/1TVoLfxJ4Ch884ZJ8vOoBUGj8HOWqXKfg742wxaVBb18/edit',
    sheetName: 'master',
    IDcol: 'entryNo',
    CPcol: 'CPkey',
    deployId: 'AKfycbywHlYXcUAhnnZ3aQ8ZtHygLCoKf29P_2FGDcdW4gaiq-k1j74z1F-1I3EEe4aHbbi2',
    API: 'https://script.google.com/macros/s/AKfycbywHlYXcUAhnnZ3aQ8ZtHygLCoKf29P_2FGDcdW4gaiq-k1j74z1F-1I3EEe4aHbbi2/exec',
    headId: 'AKfycbz68wWQbyN6DSbbKt3MQrMldoUpaT3cDonHBZ7_BeOK',
    devAPI: 'https://script.google.com/macros/s/AKfycbz68wWQbyN6DSbbKt3MQrMldoUpaT3cDonHBZ7_BeOK/dev',
    cols: {
      timestamp: 'タイムスタンプ',
      mail: 'メールアドレス',
      auth: 'authority',
      CPkey: 'CPkey',
      id: 'entryNo',
      trial: 'trial',
      editURL: 'editURL'
    }
  },
  entry: {
    title: '参加申込フォーム',
    type: 'form',
    formId: '1CfYByT_O_s7s2fPS76hIEpLfJqdenx5FdAdP7wR2DYY',
    edit: 'https://docs.google.com/forms/d/1CfYByT_O_s7s2fPS76hIEpLfJqdenx5FdAdP7wR2DYY/edit',
    view: 'https://docs.google.com/forms/d/e/1FAIpQLSfKJ5aUz4h6lTGlz6c3NjPyWMnViVQxHqwRkCnzJsRKfz9ULQ/viewform',
    shortView: 'https://tinyurl.com/2dbjtqke',
    sheetName: 'master',
    qr: 'https://api.qrserver.com/v1/create-qr-code/?data=https://docs.google.com/forms/d/e/1FAIpQLSfKJ5aUz4h6lTGlz6c3NjPyWMnViVQxHqwRkCnzJsRKfz9ULQ/viewform',
    receiptMail: '{"recipient":"::メールアドレス::","subject":"[連絡] 校庭キャンプ2024 申込受付","body":null,"options":{"attachments":null,"bcc":null,"cc":null,"from":null,"htmlBody":"<head><style type=\\"text/css\\"> .button { display : inline-block; border-radius : 5%; font-size : 18pt; text-align : center; cursor : pointer; padding : 12px 12px; background : #6666ff; color : #ffffff; line-height : 1em; transition : .3s; box-shadow : 2px 2px 3px #666666; border : 2px solid #6666ff; } .button:hover { box-shadow : none; color : #6666ff; background : #ffffff; } </style></head><body> <p>To: <span style=\\"font-size:2rem\\">::申込者氏名::</span> 様</p> <p>下北沢小おやじの会です。<br> この度は「校庭キャンプ2024」にお申し込みいただき、ありがとうございました。<br> 以下のようにお申し込みを受け付けましたのでご連絡致します。</p> <p style=\\"font-size:2rem\\">受付番号：::entryNo::</p> <p><img src=\\"https://api.qrserver.com/v1/create-qr-code/?data=::entryNo::\\" /></p> <p>※ 上のQRコードはイベント当日受付でお示しください。</p> <hr> <p>当日の予定表や会場マップ、注意事項等を掲載したパンフレットを以下に掲載しています。 事前にご確認いただけますようお願いします。</p> <p><a class=\\"button\\" href=\\"https://nakaone.github.io/public/camp2024/index.html?n=::entryNo::\\" target=\\"_blank\\">パンフレット</a></p> <p>台風接近等の事情によりイベントが中止になる場合、このサイトで告知すると共に、 お申し込みいただいたe-mailアドレス宛にご連絡差し上げます。</p> <hr> <p>申込〜イベント当日の間に何らかの事情でお申し込み内容に変更がある場合、 またはお申し込み自体をキャンセルする場合、以下から申込内容を修正いただけますようお願いします。</p> <p><a class=\\"button\\" href=\\"::editURL::\\" target=\\"_blank\\">申込内容修正</a></p> <hr> <p>ご不明な点がございましたら、以下までご連絡お願いいたします。<br>skz-oyaji@googlegroups.com</p> <p>それでは当日のご来場をお待ちしております。</p> <p style=\\"text-align:right\\">以上</p></body>","inlineImages":null,"name":"下北沢小おやじの会","replyTo":"skz-oyaji@googlegroups.com"}}'
  },
  volunteer: {
    title: 'ボランティア募集フォーム',
    type: 'form',
    edit: 'https://docs.google.com/forms/d/1M-n09_cCfbjnE4ZYeu5lClGDycoqAos1xxw9Ry7giDk/edit',
    view: 'https://docs.google.com/forms/d/e/1FAIpQLSeIr2VFqnxm_c7qgzQ-cD7rz_obus7OD0dvZWrui9j0v_cD2Q/viewform',
    shortView: 'https://tinyurl.com/29rl5vof',
    sheetName: 'ボランティア募集',
    qr: 'https://api.qrserver.com/v1/create-qr-code/?data=https://docs.google.com/forms/d/e/1FAIpQLSeIr2VFqnxm_c7qgzQ-cD7rz_obus7OD0dvZWrui9j0v_cD2Q/viewform'
  },
  participantEnquete: {
    title: '参加者アンケート',
    type: 'form',
    edit: 'https://docs.google.com/forms/d/1LPvt4n57DpvYYRtuddjHm37kSmAio6slB3MYvtJet38/edit',
    view: 'https://docs.google.com/forms/d/e/1FAIpQLSf8CsE6x3UxIFTyD7Pe1nQczq227LDmv9ypJ5kbDLmwnzjJXQ/viewform',
    shortView: 'https://tinyurl.com/24s7tce6',
    sheetName: '参加者アンケート',
    qr: 'https://api.qrserver.com/v1/create-qr-code/?data=undefined'
  },
  awareness: {
    title: '気づき投稿フォーム',
    type: 'form',
    edit: 'https://docs.google.com/forms/d/1E6C8N_H0i1WU0UfG4Tn4cECWOyZbjgYqhQzpzRtqjpQ/edit',
    view: 'https://docs.google.com/forms/d/e/1FAIpQLSefyvYCjtTUuLaZqCG7c6k9sjnCXucsSjxhHppXWFqzhC0lRg/viewform',
    shortView: 'https://tinyurl.com/2bpg2kga',
    sheetName: '気づき投稿',
    qr: 'https://api.qrserver.com/v1/create-qr-code/?data=https://docs.google.com/forms/d/e/1FAIpQLSefyvYCjtTUuLaZqCG7c6k9sjnCXucsSjxhHppXWFqzhC0lRg/viewform'
  },
  oyajiML: {
    title: 'おやじの会ML登録',
    type: 'form',
    edit: 'https://docs.google.com/forms/d/1wq0M7p2SCacwm3uzYAiTLr5OazMVBURjjd0I3TdtaT4/edit',
    view: 'https://docs.google.com/forms/d/e/1FAIpQLSfbqa_vRBQYjsn2cYkPHbsc2-xSa0AFU6AwgZMIMKAKPxcyEQ/viewform',
    shortView: 'https://tinyurl.com/23hgkfv4',
    sheet: 'https://docs.google.com/spreadsheets/d/1ns1GRROPVIDc_s2ov2lLjbudxh0uUeOzws5bOA0_ojo/edit',
    confirm: 'https://nakaone.github.io/library/oyajiML/1.0.0/index.html',
    email: 'skz-oyaji@googlegroups.com',
    qr: 'https://api.qrserver.com/v1/create-qr-code/?data=https://docs.google.com/forms/d/e/1FAIpQLSfbqa_vRBQYjsn2cYkPHbsc2-xSa0AFU6AwgZMIMKAKPxcyEQ/viewform'
  },
  faq: {
    title: '「困ったときは」(FAQサイト)',
    type: 'site',
    edit: 'https://sites.google.com/d/1cq0aV06FVKKeGFb4SQeEiYZjDPg5rnkL/p/1gtzJU8YHbtsR3tfrWeIPy6gB6IdCiIKU/edit',
    view: 'https://sites.google.com/view/skz-camp2024faq/',
    shortView: 'https://tinyurl.com/27n7sj5b',
    qr: 'https://api.qrserver.com/v1/create-qr-code/?data=https://sites.google.com/view/skz-camp2024faq/'
  }
}
      vlog(v,'conf');

      v.step = 1.4; // 受付番号の特定
      v.params = new URLSearchParams(window.location.search);
      v.conf.entryNo = v.params.get(v.conf.sys.upv) || 0;  // URLパラメータをlocalStorageより優先
      if( v.conf.entryNo === 0 ){
        // v.conf.entryNo > 0 ⇒ URLパラメータでユーザIDが指定されている(=申込受付メールからの遷移)
        // v.conf.entryNo === 0 ⇒ URLパラメータでの指定は無し
        //   localStorageにユーザIDが存在 ⇒ (一度以上申込受付メールから遷移してきた)参加者
        //   localStorageにユーザIDが不在 ⇒ 非参加者 or 直接サイトを見た参加者なので0とする
        // 　※後者についてはメニューから「受付番号入力」を行う事で参加者扱いとする。
        v.conf.entryNo = Number(localStorage.getItem(v.conf.sys.storageKey));
      }
      vlog(v,['params','conf']);
      if( v.conf.entryNo === 0 ) throw new Error('受付番号が特定できません。\n'
      + '一般公開サイトで「メニュー > 設定、その他 > 受付番号確認・入力」で受付番号を設定するか、'
      + '本サイトURL末尾に"〜?n=X"(Xは受付番号)を付与してアクセスしてください。');

      v.step = 1.5; // 受付番号をlocalStorageに保存(未確定の場合'0')
      localStorage.setItem(v.conf.sys.storageKey,v.conf.entryNo);

      v.step = 1.6; // 認証基盤をインスタンス化
      v.eq = new encryptedQuery({
        isClient: v.conf.sys.isClient,
        storageKey: v.conf.sys.storageKey,
        //pUP
        //eUP
        expire: v.conf.sys.expire,
        url: v.conf.master.API,
        clientId: v.conf.entryNo,
        bits: v.conf.sys.auth.bits,
      });
    })();

    v.step = 2; // 前回のパスコード通知メール発行要求が10分以上前、または要求自体した記録がないなら発行要求
    v.r = await v.eq.request();
    vlog(v,'r');
    if( v.r instanceof Error ) throw v.r;
    if( v.r.status < 0 ) throw new Error(v.r.message);

    v.step = 3; // パスコード入力
    v.passcode = null;
    v.msg = 'メールでパスコードを送信しました。\n';
    for( v.cnt=0 ; v.cnt<3 ; v.cnt++ ){

      v.step = 3.1; // パスコード入力ダイアログ表示
      v.passcode = window.prompt(v.msg + 'メール記載のパスコードを入力してください。');

      if( v.passcode ){
        v.step = 3.2; // パスコード有効性検証要求
        v.r = await v.eq.request(Number(v.passcode));
        if( v.r instanceof Error ) throw v.r;
        vlog(v,'r');

        switch( v.r.status ){
          case 1: // 正当性検証OK ⇒ シート全情報をsessionStorageに保存
            sessionStorage.setItem(v.conf.sys.storageKey,JSON.stringify({
              header:v.r.header,
              data:v.r.data,
              expire: v.r.expire,
            }));
            v.cnt = 3;
            break;
          case 0: // 検証NGだが再試行可 ⇒ 入力値をクリアしてもう一度
            v.passcode = null;
            v.msg = v.r.message;
            break;
          default: // エラー ⇒ メッセージを出して終了
            throw new Error(v.r.message);      
        }
      } else {
        // ダイアログでキャンセルされた場合、内容を消去して終了
        throw new Error('スタッフ専用サイトは認証が必要です。\n'
          + 'パスコード確認のため一度メールアプリに切り替えていた場合、'
          + 'リロードしてから改めてパスコード入力してください。'
        );
      }
    }

    (()=>{ v.step = 4; // 画面の準備
      
      v.step = 4.1; // 受付業務の準備
      // v.rにシートデータが入っていること
      v.Reception = new Reception({
        wrapper: '.Reception[name="wrapper"]',
        header: v.r.header,
        data: v.r.data,
        filter: (o,key) => {  // 検索キーを元にした候補者の抽出条件
          // 数字なら受付番号と看做してentryNoと一致、非数字なら申込者氏名/カナに部分一致
          return !isNaN(key) ? Number(o.entryNo) === Number(key)
          : (o['申込者氏名'].indexOf(key) >= 0 || o['申込者カナ'].indexOf(key) >= 0)
        },
      });
      if( v.Reception instanceof Error ) throw v.Reception;

      v.step = 4.2; // 参加者集計の作成
      v.r = summaryTable({
        wrapper: 'div[title="summaryTable"] [title="wrapper"]',
        data: v.r.data,
        cols: ['テント','体育館','宿泊計','日帰り','参加計','参加取消'],
        rows: ['申込口数',
          '1年生','2年生','3年生','4年生','5年生','6年生','在校生計',
          '未就学児','卒業生','保護者','関係者計','申込人数計','おやじの会'],
        colsFormula: ['宿泊計=テント+体育館','参加計=宿泊計+日帰り'],
        rowsFormula: [
          '在校生計=1年生+2年生+3年生+4年生+5年生+6年生',
          '関係者計=未就学児+卒業生+保護者',
          '申込人数計=在校生計+関係者計',
        ],
        normalize: o => { /* データの正規化方法の定義
          1行分のObject = {
            "申込者の参加": "参加予定(宿泊なし)",
            "宿泊、テント": "宿泊しない",
            "参加者01所属": "1年生",
            "参加者02所属": "2年生",
            "参加者03所属": "2年生"
          }
          
          [{row:"申込口数",col:"日帰り"},
          {row:"1年生",col:"日帰り"},
          {row:"2年生",col:"日帰り"}, // 1件1Objとする(まとめない)
          {row:"2年生",col:"日帰り"}]
          */
          const v = {rv:[],
            cancel: (o['キャンセル'] && o['キャンセル'].length > 0 ? true : false),
            oyaji: (o['申込者の参加'].match(/おやじ/) ? true : false),
            stay: (o['宿泊、テント'] === '宿泊しない' ? false : true),
            tent: (o['宿泊、テント'].match(/あり/) ? true : false),
          };
          v.col = v.cancel  // 計上する欄の特定
            ? '参加取消'
            : ( v.oyaji
              ? (v.stay ? '宿泊計' : '日帰り')
              : (v.stay ? (v.tent ? 'テント' : '体育館') : '日帰り'));
  
          if( v.oyaji === false ) // 申込口数の登録
            v.rv.push({row:'申込口数',col:v.col});
  
          if( v.oyaji ) v.rv.push({row:'おやじの会',col:v.col}); // 申込者の登録
          else if( o['申込者の参加'].match(/参加予定/) ) v.rv.push({row:'保護者',col:v.col});
  
          for( v.i=1 ; v.i<6 ; v.i++ ) // 参加者01〜05の登録
            if( o[`参加者0${v.i}所属`] ) v.rv.push({row:o[`参加者0${v.i}所属`],col:v.col});
  
          return v.rv;
        },
        thead: [
          {tag:'tr',children:[
            {tag:'th',attr:{colspan:3,rowspan:3}},
            {tag:'th',attr:{colspan:5},text:'参加予定'},
            {tag:'th',attr:{rowspan:3},text:'参加取消'},
          ]},
          {tag:'tr',children:[
            {tag:'th',attr:{colspan:3},text:'宿泊'},
            {tag:'th',attr:{rowspan:2},text:'日帰り'},
            {tag:'th',attr:{rowspan:2},text:'参加計'},
          ]},
          {tag:'tr',children:[
            {tag:'th',text:'テント'},
            {tag:'th',text:'体育館'},
            {tag:'th',text:'宿泊計'},
          ]},
        ],
        tbody: [
          {tag:'tr',children:[{tag:'th',attr:{colspan:3},text:'申込口数'}]},
          {tag:'tr',children:[
            {tag:'th',attr:{rowspan:13},text:'申込人数'},
            {tag:'th',attr:{rowspan:7},text:'在校生'},
            {tag:'th',text:'1年生'}
          ]},
          {tag:'tr',children:[{tag:'th',text:'2年生'}]},
          {tag:'tr',children:[{tag:'th',text:'3年生'}]},
          {tag:'tr',children:[{tag:'th',text:'4年生'}]},
          {tag:'tr',children:[{tag:'th',text:'5年生'}]},
          {tag:'tr',children:[{tag:'th',text:'6年生'}]},
          {tag:'tr',children:[{tag:'th',text:'在校生計'}]},
          {tag:'tr',children:[
            {tag:'th',attr:{rowspan:4},text:'関係者'},
            {tag:'th',text:'未就学児'},
          ]},
          {tag:'tr',children:[{tag:'th',text:'卒業生'}]},
          {tag:'tr',children:[{tag:'th',text:'保護者'}]},
          {tag:'tr',children:[{tag:'th',text:'関係者計'}]},
          {tag:'tr',children:[{tag:'th',attr:{colspan:2},text:'申込人数計'}]},
          {tag:'tr',children:[{tag:'th',attr:{colspan:2},text:'おやじの会'}]},
        ],
      });
      if( v.r instanceof Error ) throw v.r;

      v.step = 4.3; // メニュー作成
      // ※Receptionインスタンス作成後に実行
      v.menu = new BurgerMenu({home:'ホーム',func:{
        recept: async () => {  // 受付番号or検索キー入力
          changeScreen('受付業務'); // data-BurgerMenu:id
          await v.Reception.targeting();
        },
      }});
      if( v.menu instanceof Error ) throw v.menu;

      v.step = 4.4; // URLの埋め込み(位置指定属性を持つHTML要素に変数を代入)
      v.r = assignVariables({data:v.conf});
      if( v.r instanceof Error ) throw v.r;

    })();

    v.step = 99; // 終了処理
    v.loading.hide();
    console.log(`${v.whois} normal end.`);
    return v.rv;
  } catch(e) {
    e.message = `${v.whois} abnormal end at step.${v.step}\n${e.message}`;
    console.error(`${e.message}\nv=${JSON.stringify(v)}`);
    v.loading.hide();
    document.querySelector('.BurgerMenu[name="wrapper"]').innerHTML = '';
    document.querySelectorAll('script').forEach(dom => dom.innerHTML = '');
    alert(e.message);
  }
});
</script>
<script type="text/javascript" title="cryptico">
var dbits,canary=244837814094590,j_lm=(canary&16777215)==15715070;function BigInteger(a,b,c){a!=null&&("number"==typeof a?this.fromNumber(a,b,c):b==null&&"string"!=typeof a?this.fromString(a,256):this.fromString(a,b))}function nbi(){return new BigInteger(null)}function am1(a,b,c,d,e,g){for(;--g>=0;){var h=b*this[a++]+c[d]+e,e=Math.floor(h/67108864);c[d++]=h&67108863}return e}
function am2(a,b,c,d,e,g){var h=b&32767;for(b>>=15;--g>=0;){var f=this[a]&32767,o=this[a++]>>15,p=b*f+o*h,f=h*f+((p&32767)<<15)+c[d]+(e&1073741823),e=(f>>>30)+(p>>>15)+b*o+(e>>>30);c[d++]=f&1073741823}return e}function am3(a,b,c,d,e,g){var h=b&16383;for(b>>=14;--g>=0;){var f=this[a]&16383,o=this[a++]>>14,p=b*f+o*h,f=h*f+((p&16383)<<14)+c[d]+e,e=(f>>28)+(p>>14)+b*o;c[d++]=f&268435455}return e}
j_lm&&navigator.appName=="Microsoft Internet Explorer"?(BigInteger.prototype.am=am2,dbits=30):j_lm&&navigator.appName!="Netscape"?(BigInteger.prototype.am=am1,dbits=26):(BigInteger.prototype.am=am3,dbits=28);BigInteger.prototype.DB=dbits;BigInteger.prototype.DM=(1<<dbits)-1;BigInteger.prototype.DV=1<<dbits;var BI_FP=52;BigInteger.prototype.FV=Math.pow(2,BI_FP);BigInteger.prototype.F1=BI_FP-dbits;BigInteger.prototype.F2=2*dbits-BI_FP;var BI_RM="0123456789abcdefghijklmnopqrstuvwxyz",BI_RC=[],rr,vv;
rr="0".charCodeAt(0);for(vv=0;vv<=9;++vv)BI_RC[rr++]=vv;rr="a".charCodeAt(0);for(vv=10;vv<36;++vv)BI_RC[rr++]=vv;rr="A".charCodeAt(0);for(vv=10;vv<36;++vv)BI_RC[rr++]=vv;function int2char(a){return BI_RM.charAt(a)}function intAt(a,b){var c=BI_RC[a.charCodeAt(b)];return c==null?-1:c}function bnpCopyTo(a){for(var b=this.t-1;b>=0;--b)a[b]=this[b];a.t=this.t;a.s=this.s}function bnpFromInt(a){this.t=1;this.s=a<0?-1:0;a>0?this[0]=a:a<-1?this[0]=a+DV:this.t=0}
function nbv(a){var b=nbi();b.fromInt(a);return b}
function bnpFromString(a,b){var c;if(b==16)c=4;else if(b==8)c=3;else if(b==256)c=8;else if(b==2)c=1;else if(b==32)c=5;else if(b==4)c=2;else{this.fromRadix(a,b);return}this.s=this.t=0;for(var d=a.length,e=!1,g=0;--d>=0;){var h=c==8?a[d]&255:intAt(a,d);h<0?a.charAt(d)=="-"&&(e=!0):(e=!1,g==0?this[this.t++]=h:g+c>this.DB?(this[this.t-1]|=(h&(1<<this.DB-g)-1)<<g,this[this.t++]=h>>this.DB-g):this[this.t-1]|=h<<g,g+=c,g>=this.DB&&(g-=this.DB))}if(c==8&&(a[0]&128)!=0)this.s=-1,g>0&&(this[this.t-1]|=(1<<
this.DB-g)-1<<g);this.clamp();e&&BigInteger.ZERO.subTo(this,this)}function bnpClamp(){for(var a=this.s&this.DM;this.t>0&&this[this.t-1]==a;)--this.t}
function bnToString(a){if(this.s<0)return"-"+this.negate().toString(a);if(a==16)a=4;else if(a==8)a=3;else if(a==2)a=1;else if(a==32)a=5;else if(a==64)a=6;else if(a==4)a=2;else return this.toRadix(a);var b=(1<<a)-1,c,d=!1,e="",g=this.t,h=this.DB-g*this.DB%a;if(g-- >0){if(h<this.DB&&(c=this[g]>>h)>0)d=!0,e=int2char(c);for(;g>=0;)h<a?(c=(this[g]&(1<<h)-1)<<a-h,c|=this[--g]>>(h+=this.DB-a)):(c=this[g]>>(h-=a)&b,h<=0&&(h+=this.DB,--g)),c>0&&(d=!0),d&&(e+=int2char(c))}return d?e:"0"}
function bnNegate(){var a=nbi();BigInteger.ZERO.subTo(this,a);return a}function bnAbs(){return this.s<0?this.negate():this}function bnCompareTo(a){var b=this.s-a.s;if(b!=0)return b;var c=this.t,b=c-a.t;if(b!=0)return b;for(;--c>=0;)if((b=this[c]-a[c])!=0)return b;return 0}function nbits(a){var b=1,c;if((c=a>>>16)!=0)a=c,b+=16;if((c=a>>8)!=0)a=c,b+=8;if((c=a>>4)!=0)a=c,b+=4;if((c=a>>2)!=0)a=c,b+=2;a>>1!=0&&(b+=1);return b}
function bnBitLength(){return this.t<=0?0:this.DB*(this.t-1)+nbits(this[this.t-1]^this.s&this.DM)}function bnpDLShiftTo(a,b){var c;for(c=this.t-1;c>=0;--c)b[c+a]=this[c];for(c=a-1;c>=0;--c)b[c]=0;b.t=this.t+a;b.s=this.s}function bnpDRShiftTo(a,b){for(var c=a;c<this.t;++c)b[c-a]=this[c];b.t=Math.max(this.t-a,0);b.s=this.s}
function bnpLShiftTo(a,b){var c=a%this.DB,d=this.DB-c,e=(1<<d)-1,g=Math.floor(a/this.DB),h=this.s<<c&this.DM,f;for(f=this.t-1;f>=0;--f)b[f+g+1]=this[f]>>d|h,h=(this[f]&e)<<c;for(f=g-1;f>=0;--f)b[f]=0;b[g]=h;b.t=this.t+g+1;b.s=this.s;b.clamp()}
function bnpRShiftTo(a,b){b.s=this.s;var c=Math.floor(a/this.DB);if(c>=this.t)b.t=0;else{var d=a%this.DB,e=this.DB-d,g=(1<<d)-1;b[0]=this[c]>>d;for(var h=c+1;h<this.t;++h)b[h-c-1]|=(this[h]&g)<<e,b[h-c]=this[h]>>d;d>0&&(b[this.t-c-1]|=(this.s&g)<<e);b.t=this.t-c;b.clamp()}}
function bnpSubTo(a,b){for(var c=0,d=0,e=Math.min(a.t,this.t);c<e;)d+=this[c]-a[c],b[c++]=d&this.DM,d>>=this.DB;if(a.t<this.t){for(d-=a.s;c<this.t;)d+=this[c],b[c++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;c<a.t;)d-=a[c],b[c++]=d&this.DM,d>>=this.DB;d-=a.s}b.s=d<0?-1:0;d<-1?b[c++]=this.DV+d:d>0&&(b[c++]=d);b.t=c;b.clamp()}
function bnpMultiplyTo(a,b){var c=this.abs(),d=a.abs(),e=c.t;for(b.t=e+d.t;--e>=0;)b[e]=0;for(e=0;e<d.t;++e)b[e+c.t]=c.am(0,d[e],b,e,0,c.t);b.s=0;b.clamp();this.s!=a.s&&BigInteger.ZERO.subTo(b,b)}function bnpSquareTo(a){for(var b=this.abs(),c=a.t=2*b.t;--c>=0;)a[c]=0;for(c=0;c<b.t-1;++c){var d=b.am(c,b[c],a,2*c,0,1);if((a[c+b.t]+=b.am(c+1,2*b[c],a,2*c+1,d,b.t-c-1))>=b.DV)a[c+b.t]-=b.DV,a[c+b.t+1]=1}a.t>0&&(a[a.t-1]+=b.am(c,b[c],a,2*c,0,1));a.s=0;a.clamp()}
function bnpDivRemTo(a,b,c){var d=a.abs();if(!(d.t<=0)){var e=this.abs();if(e.t<d.t)b!=null&&b.fromInt(0),c!=null&&this.copyTo(c);else{c==null&&(c=nbi());var g=nbi(),h=this.s,a=a.s,f=this.DB-nbits(d[d.t-1]);f>0?(d.lShiftTo(f,g),e.lShiftTo(f,c)):(d.copyTo(g),e.copyTo(c));d=g.t;e=g[d-1];if(e!=0){var o=e*(1<<this.F1)+(d>1?g[d-2]>>this.F2:0),p=this.FV/o,o=(1<<this.F1)/o,q=1<<this.F2,n=c.t,k=n-d,j=b==null?nbi():b;g.dlShiftTo(k,j);c.compareTo(j)>=0&&(c[c.t++]=1,c.subTo(j,c));BigInteger.ONE.dlShiftTo(d,
j);for(j.subTo(g,g);g.t<d;)g[g.t++]=0;for(;--k>=0;){var l=c[--n]==e?this.DM:Math.floor(c[n]*p+(c[n-1]+q)*o);if((c[n]+=g.am(0,l,c,k,0,d))<l){g.dlShiftTo(k,j);for(c.subTo(j,c);c[n]<--l;)c.subTo(j,c)}}b!=null&&(c.drShiftTo(d,b),h!=a&&BigInteger.ZERO.subTo(b,b));c.t=d;c.clamp();f>0&&c.rShiftTo(f,c);h<0&&BigInteger.ZERO.subTo(c,c)}}}}function bnMod(a){var b=nbi();this.abs().divRemTo(a,null,b);this.s<0&&b.compareTo(BigInteger.ZERO)>0&&a.subTo(b,b);return b}function Classic(a){this.m=a}
function cConvert(a){return a.s<0||a.compareTo(this.m)>=0?a.mod(this.m):a}function cRevert(a){return a}function cReduce(a){a.divRemTo(this.m,null,a)}function cMulTo(a,b,c){a.multiplyTo(b,c);this.reduce(c)}function cSqrTo(a,b){a.squareTo(b);this.reduce(b)}Classic.prototype.convert=cConvert;Classic.prototype.revert=cRevert;Classic.prototype.reduce=cReduce;Classic.prototype.mulTo=cMulTo;Classic.prototype.sqrTo=cSqrTo;
function bnpInvDigit(){if(this.t<1)return 0;var a=this[0];if((a&1)==0)return 0;var b=a&3,b=b*(2-(a&15)*b)&15,b=b*(2-(a&255)*b)&255,b=b*(2-((a&65535)*b&65535))&65535,b=b*(2-a*b%this.DV)%this.DV;return b>0?this.DV-b:-b}function Montgomery(a){this.m=a;this.mp=a.invDigit();this.mpl=this.mp&32767;this.mph=this.mp>>15;this.um=(1<<a.DB-15)-1;this.mt2=2*a.t}
function montConvert(a){var b=nbi();a.abs().dlShiftTo(this.m.t,b);b.divRemTo(this.m,null,b);a.s<0&&b.compareTo(BigInteger.ZERO)>0&&this.m.subTo(b,b);return b}function montRevert(a){var b=nbi();a.copyTo(b);this.reduce(b);return b}
function montReduce(a){for(;a.t<=this.mt2;)a[a.t++]=0;for(var b=0;b<this.m.t;++b){var c=a[b]&32767,d=c*this.mpl+((c*this.mph+(a[b]>>15)*this.mpl&this.um)<<15)&a.DM,c=b+this.m.t;for(a[c]+=this.m.am(0,d,a,b,0,this.m.t);a[c]>=a.DV;)a[c]-=a.DV,a[++c]++}a.clamp();a.drShiftTo(this.m.t,a);a.compareTo(this.m)>=0&&a.subTo(this.m,a)}function montSqrTo(a,b){a.squareTo(b);this.reduce(b)}function montMulTo(a,b,c){a.multiplyTo(b,c);this.reduce(c)}Montgomery.prototype.convert=montConvert;
Montgomery.prototype.revert=montRevert;Montgomery.prototype.reduce=montReduce;Montgomery.prototype.mulTo=montMulTo;Montgomery.prototype.sqrTo=montSqrTo;function bnpIsEven(){return(this.t>0?this[0]&1:this.s)==0}function bnpExp(a,b){if(a>4294967295||a<1)return BigInteger.ONE;var c=nbi(),d=nbi(),e=b.convert(this),g=nbits(a)-1;for(e.copyTo(c);--g>=0;)if(b.sqrTo(c,d),(a&1<<g)>0)b.mulTo(d,e,c);else var h=c,c=d,d=h;return b.revert(c)}
function bnModPowInt(a,b){var c;c=a<256||b.isEven()?new Classic(b):new Montgomery(b);return this.exp(a,c)}BigInteger.prototype.copyTo=bnpCopyTo;BigInteger.prototype.fromInt=bnpFromInt;BigInteger.prototype.fromString=bnpFromString;BigInteger.prototype.clamp=bnpClamp;BigInteger.prototype.dlShiftTo=bnpDLShiftTo;BigInteger.prototype.drShiftTo=bnpDRShiftTo;BigInteger.prototype.lShiftTo=bnpLShiftTo;BigInteger.prototype.rShiftTo=bnpRShiftTo;BigInteger.prototype.subTo=bnpSubTo;
BigInteger.prototype.multiplyTo=bnpMultiplyTo;BigInteger.prototype.squareTo=bnpSquareTo;BigInteger.prototype.divRemTo=bnpDivRemTo;BigInteger.prototype.invDigit=bnpInvDigit;BigInteger.prototype.isEven=bnpIsEven;BigInteger.prototype.exp=bnpExp;BigInteger.prototype.toString=bnToString;BigInteger.prototype.negate=bnNegate;BigInteger.prototype.abs=bnAbs;BigInteger.prototype.compareTo=bnCompareTo;BigInteger.prototype.bitLength=bnBitLength;BigInteger.prototype.mod=bnMod;BigInteger.prototype.modPowInt=bnModPowInt;
BigInteger.ZERO=nbv(0);BigInteger.ONE=nbv(1);function bnClone(){var a=nbi();this.copyTo(a);return a}function bnIntValue(){if(this.s<0)if(this.t==1)return this[0]-this.DV;else{if(this.t==0)return-1}else if(this.t==1)return this[0];else if(this.t==0)return 0;return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function bnByteValue(){return this.t==0?this.s:this[0]<<24>>24}function bnShortValue(){return this.t==0?this.s:this[0]<<16>>16}
function bnpChunkSize(a){return Math.floor(Math.LN2*this.DB/Math.log(a))}function bnSigNum(){return this.s<0?-1:this.t<=0||this.t==1&&this[0]<=0?0:1}function bnpToRadix(a){a==null&&(a=10);if(this.signum()==0||a<2||a>36)return"0";var b=this.chunkSize(a),b=Math.pow(a,b),c=nbv(b),d=nbi(),e=nbi(),g="";for(this.divRemTo(c,d,e);d.signum()>0;)g=(b+e.intValue()).toString(a).substr(1)+g,d.divRemTo(c,d,e);return e.intValue().toString(a)+g}
function bnpFromRadix(a,b){this.fromInt(0);b==null&&(b=10);for(var c=this.chunkSize(b),d=Math.pow(b,c),e=!1,g=0,h=0,f=0;f<a.length;++f){var o=intAt(a,f);o<0?a.charAt(f)=="-"&&this.signum()==0&&(e=!0):(h=b*h+o,++g>=c&&(this.dMultiply(d),this.dAddOffset(h,0),h=g=0))}g>0&&(this.dMultiply(Math.pow(b,g)),this.dAddOffset(h,0));e&&BigInteger.ZERO.subTo(this,this)}
function bnpFromNumber(a,b,c){if("number"==typeof b)if(a<2)this.fromInt(1);else{this.fromNumber(a,c);this.testBit(a-1)||this.bitwiseTo(BigInteger.ONE.shiftLeft(a-1),op_or,this);for(this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(b);)this.dAddOffset(2,0),this.bitLength()>a&&this.subTo(BigInteger.ONE.shiftLeft(a-1),this)}else{var c=[],d=a&7;c.length=(a>>3)+1;b.nextBytes(c);d>0?c[0]&=(1<<d)-1:c[0]=0;this.fromString(c,256)}}
function bnToByteArray(){var a=this.t,b=[];b[0]=this.s;var c=this.DB-a*this.DB%8,d,e=0;if(a-- >0){if(c<this.DB&&(d=this[a]>>c)!=(this.s&this.DM)>>c)b[e++]=d|this.s<<this.DB-c;for(;a>=0;)if(c<8?(d=(this[a]&(1<<c)-1)<<8-c,d|=this[--a]>>(c+=this.DB-8)):(d=this[a]>>(c-=8)&255,c<=0&&(c+=this.DB,--a)),(d&128)!=0&&(d|=-256),e==0&&(this.s&128)!=(d&128)&&++e,e>0||d!=this.s)b[e++]=d}return b}function bnEquals(a){return this.compareTo(a)==0}function bnMin(a){return this.compareTo(a)<0?this:a}
function bnMax(a){return this.compareTo(a)>0?this:a}function bnpBitwiseTo(a,b,c){var d,e,g=Math.min(a.t,this.t);for(d=0;d<g;++d)c[d]=b(this[d],a[d]);if(a.t<this.t){e=a.s&this.DM;for(d=g;d<this.t;++d)c[d]=b(this[d],e);c.t=this.t}else{e=this.s&this.DM;for(d=g;d<a.t;++d)c[d]=b(e,a[d]);c.t=a.t}c.s=b(this.s,a.s);c.clamp()}function op_and(a,b){return a&b}function bnAnd(a){var b=nbi();this.bitwiseTo(a,op_and,b);return b}function op_or(a,b){return a|b}
function bnOr(a){var b=nbi();this.bitwiseTo(a,op_or,b);return b}function op_xor(a,b){return a^b}function bnXor(a){var b=nbi();this.bitwiseTo(a,op_xor,b);return b}function op_andnot(a,b){return a&~b}function bnAndNot(a){var b=nbi();this.bitwiseTo(a,op_andnot,b);return b}function bnNot(){for(var a=nbi(),b=0;b<this.t;++b)a[b]=this.DM&~this[b];a.t=this.t;a.s=~this.s;return a}function bnShiftLeft(a){var b=nbi();a<0?this.rShiftTo(-a,b):this.lShiftTo(a,b);return b}
function bnShiftRight(a){var b=nbi();a<0?this.lShiftTo(-a,b):this.rShiftTo(a,b);return b}function lbit(a){if(a==0)return-1;var b=0;(a&65535)==0&&(a>>=16,b+=16);(a&255)==0&&(a>>=8,b+=8);(a&15)==0&&(a>>=4,b+=4);(a&3)==0&&(a>>=2,b+=2);(a&1)==0&&++b;return b}function bnGetLowestSetBit(){for(var a=0;a<this.t;++a)if(this[a]!=0)return a*this.DB+lbit(this[a]);return this.s<0?this.t*this.DB:-1}function cbit(a){for(var b=0;a!=0;)a&=a-1,++b;return b}
function bnBitCount(){for(var a=0,b=this.s&this.DM,c=0;c<this.t;++c)a+=cbit(this[c]^b);return a}function bnTestBit(a){var b=Math.floor(a/this.DB);return b>=this.t?this.s!=0:(this[b]&1<<a%this.DB)!=0}function bnpChangeBit(a,b){var c=BigInteger.ONE.shiftLeft(a);this.bitwiseTo(c,b,c);return c}function bnSetBit(a){return this.changeBit(a,op_or)}function bnClearBit(a){return this.changeBit(a,op_andnot)}function bnFlipBit(a){return this.changeBit(a,op_xor)}
function bnpAddTo(a,b){for(var c=0,d=0,e=Math.min(a.t,this.t);c<e;)d+=this[c]+a[c],b[c++]=d&this.DM,d>>=this.DB;if(a.t<this.t){for(d+=a.s;c<this.t;)d+=this[c],b[c++]=d&this.DM,d>>=this.DB;d+=this.s}else{for(d+=this.s;c<a.t;)d+=a[c],b[c++]=d&this.DM,d>>=this.DB;d+=a.s}b.s=d<0?-1:0;d>0?b[c++]=d:d<-1&&(b[c++]=this.DV+d);b.t=c;b.clamp()}function bnAdd(a){var b=nbi();this.addTo(a,b);return b}function bnSubtract(a){var b=nbi();this.subTo(a,b);return b}
function bnMultiply(a){var b=nbi();this.multiplyTo(a,b);return b}function bnSquare(){var a=nbi();this.squareTo(a);return a}function bnDivide(a){var b=nbi();this.divRemTo(a,b,null);return b}function bnRemainder(a){var b=nbi();this.divRemTo(a,null,b);return b}function bnDivideAndRemainder(a){var b=nbi(),c=nbi();this.divRemTo(a,b,c);return[b,c]}function bnpDMultiply(a){this[this.t]=this.am(0,a-1,this,0,0,this.t);++this.t;this.clamp()}
function bnpDAddOffset(a,b){if(a!=0){for(;this.t<=b;)this[this.t++]=0;for(this[b]+=a;this[b]>=this.DV;)this[b]-=this.DV,++b>=this.t&&(this[this.t++]=0),++this[b]}}function NullExp(){}function nNop(a){return a}function nMulTo(a,b,c){a.multiplyTo(b,c)}function nSqrTo(a,b){a.squareTo(b)}NullExp.prototype.convert=nNop;NullExp.prototype.revert=nNop;NullExp.prototype.mulTo=nMulTo;NullExp.prototype.sqrTo=nSqrTo;function bnPow(a){return this.exp(a,new NullExp)}
function bnpMultiplyLowerTo(a,b,c){var d=Math.min(this.t+a.t,b);c.s=0;for(c.t=d;d>0;)c[--d]=0;var e;for(e=c.t-this.t;d<e;++d)c[d+this.t]=this.am(0,a[d],c,d,0,this.t);for(e=Math.min(a.t,b);d<e;++d)this.am(0,a[d],c,d,0,b-d);c.clamp()}function bnpMultiplyUpperTo(a,b,c){--b;var d=c.t=this.t+a.t-b;for(c.s=0;--d>=0;)c[d]=0;for(d=Math.max(b-this.t,0);d<a.t;++d)c[this.t+d-b]=this.am(b-d,a[d],c,0,0,this.t+d-b);c.clamp();c.drShiftTo(1,c)}
function Barrett(a){this.r2=nbi();this.q3=nbi();BigInteger.ONE.dlShiftTo(2*a.t,this.r2);this.mu=this.r2.divide(a);this.m=a}function barrettConvert(a){if(a.s<0||a.t>2*this.m.t)return a.mod(this.m);else if(a.compareTo(this.m)<0)return a;else{var b=nbi();a.copyTo(b);this.reduce(b);return b}}function barrettRevert(a){return a}
function barrettReduce(a){a.drShiftTo(this.m.t-1,this.r2);if(a.t>this.m.t+1)a.t=this.m.t+1,a.clamp();this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3);for(this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);a.compareTo(this.r2)<0;)a.dAddOffset(1,this.m.t+1);for(a.subTo(this.r2,a);a.compareTo(this.m)>=0;)a.subTo(this.m,a)}function barrettSqrTo(a,b){a.squareTo(b);this.reduce(b)}function barrettMulTo(a,b,c){a.multiplyTo(b,c);this.reduce(c)}Barrett.prototype.convert=barrettConvert;
Barrett.prototype.revert=barrettRevert;Barrett.prototype.reduce=barrettReduce;Barrett.prototype.mulTo=barrettMulTo;Barrett.prototype.sqrTo=barrettSqrTo;
function bnModPow(a,b){var c=a.bitLength(),d,e=nbv(1),g;if(c<=0)return e;else d=c<18?1:c<48?3:c<144?4:c<768?5:6;g=c<8?new Classic(b):b.isEven()?new Barrett(b):new Montgomery(b);var h=[],f=3,o=d-1,p=(1<<d)-1;h[1]=g.convert(this);if(d>1){c=nbi();for(g.sqrTo(h[1],c);f<=p;)h[f]=nbi(),g.mulTo(c,h[f-2],h[f]),f+=2}for(var q=a.t-1,n,k=!0,j=nbi(),c=nbits(a[q])-1;q>=0;){c>=o?n=a[q]>>c-o&p:(n=(a[q]&(1<<c+1)-1)<<o-c,q>0&&(n|=a[q-1]>>this.DB+c-o));for(f=d;(n&1)==0;)n>>=1,--f;if((c-=f)<0)c+=this.DB,--q;if(k)h[n].copyTo(e),
k=!1;else{for(;f>1;)g.sqrTo(e,j),g.sqrTo(j,e),f-=2;f>0?g.sqrTo(e,j):(f=e,e=j,j=f);g.mulTo(j,h[n],e)}for(;q>=0&&(a[q]&1<<c)==0;)g.sqrTo(e,j),f=e,e=j,j=f,--c<0&&(c=this.DB-1,--q)}return g.revert(e)}
function bnGCD(a){var b=this.s<0?this.negate():this.clone(),a=a.s<0?a.negate():a.clone();if(b.compareTo(a)<0)var c=b,b=a,a=c;var c=b.getLowestSetBit(),d=a.getLowestSetBit();if(d<0)return b;c<d&&(d=c);d>0&&(b.rShiftTo(d,b),a.rShiftTo(d,a));for(;b.signum()>0;)(c=b.getLowestSetBit())>0&&b.rShiftTo(c,b),(c=a.getLowestSetBit())>0&&a.rShiftTo(c,a),b.compareTo(a)>=0?(b.subTo(a,b),b.rShiftTo(1,b)):(a.subTo(b,a),a.rShiftTo(1,a));d>0&&a.lShiftTo(d,a);return a}
function bnpModInt(a){if(a<=0)return 0;var b=this.DV%a,c=this.s<0?a-1:0;if(this.t>0)if(b==0)c=this[0]%a;else for(var d=this.t-1;d>=0;--d)c=(b*c+this[d])%a;return c}
function bnModInverse(a){var b=a.isEven();if(this.isEven()&&b||a.signum()==0)return BigInteger.ZERO;for(var c=a.clone(),d=this.clone(),e=nbv(1),g=nbv(0),h=nbv(0),f=nbv(1);c.signum()!=0;){for(;c.isEven();){c.rShiftTo(1,c);if(b){if(!e.isEven()||!g.isEven())e.addTo(this,e),g.subTo(a,g);e.rShiftTo(1,e)}else g.isEven()||g.subTo(a,g);g.rShiftTo(1,g)}for(;d.isEven();){d.rShiftTo(1,d);if(b){if(!h.isEven()||!f.isEven())h.addTo(this,h),f.subTo(a,f);h.rShiftTo(1,h)}else f.isEven()||f.subTo(a,f);f.rShiftTo(1,
f)}c.compareTo(d)>=0?(c.subTo(d,c),b&&e.subTo(h,e),g.subTo(f,g)):(d.subTo(c,d),b&&h.subTo(e,h),f.subTo(g,f))}if(d.compareTo(BigInteger.ONE)!=0)return BigInteger.ZERO;if(f.compareTo(a)>=0)return f.subtract(a);if(f.signum()<0)f.addTo(a,f);else return f;return f.signum()<0?f.add(a):f}
var lowprimes=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,
733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],lplim=67108864/lowprimes[lowprimes.length-1];
function bnIsProbablePrime(a){var b,c=this.abs();if(c.t==1&&c[0]<=lowprimes[lowprimes.length-1]){for(b=0;b<lowprimes.length;++b)if(c[0]==lowprimes[b])return!0;return!1}if(c.isEven())return!1;for(b=1;b<lowprimes.length;){for(var d=lowprimes[b],e=b+1;e<lowprimes.length&&d<lplim;)d*=lowprimes[e++];for(d=c.modInt(d);b<e;)if(d%lowprimes[b++]==0)return!1}return c.millerRabin(a)}
function bnpMillerRabin(a){var b=this.subtract(BigInteger.ONE),c=b.getLowestSetBit();if(c<=0)return!1;var d=b.shiftRight(c),a=a+1>>1;if(a>lowprimes.length)a=lowprimes.length;for(var e=nbi(),g=0;g<a;++g){e.fromInt(lowprimes[Math.floor(Math.random()*lowprimes.length)]);var h=e.modPow(d,this);if(h.compareTo(BigInteger.ONE)!=0&&h.compareTo(b)!=0){for(var f=1;f++<c&&h.compareTo(b)!=0;)if(h=h.modPowInt(2,this),h.compareTo(BigInteger.ONE)==0)return!1;if(h.compareTo(b)!=0)return!1}}return!0}
BigInteger.prototype.chunkSize=bnpChunkSize;BigInteger.prototype.toRadix=bnpToRadix;BigInteger.prototype.fromRadix=bnpFromRadix;BigInteger.prototype.fromNumber=bnpFromNumber;BigInteger.prototype.bitwiseTo=bnpBitwiseTo;BigInteger.prototype.changeBit=bnpChangeBit;BigInteger.prototype.addTo=bnpAddTo;BigInteger.prototype.dMultiply=bnpDMultiply;BigInteger.prototype.dAddOffset=bnpDAddOffset;BigInteger.prototype.multiplyLowerTo=bnpMultiplyLowerTo;BigInteger.prototype.multiplyUpperTo=bnpMultiplyUpperTo;
BigInteger.prototype.modInt=bnpModInt;BigInteger.prototype.millerRabin=bnpMillerRabin;BigInteger.prototype.clone=bnClone;BigInteger.prototype.intValue=bnIntValue;BigInteger.prototype.byteValue=bnByteValue;BigInteger.prototype.shortValue=bnShortValue;BigInteger.prototype.signum=bnSigNum;BigInteger.prototype.toByteArray=bnToByteArray;BigInteger.prototype.equals=bnEquals;BigInteger.prototype.min=bnMin;BigInteger.prototype.max=bnMax;BigInteger.prototype.and=bnAnd;BigInteger.prototype.or=bnOr;
BigInteger.prototype.xor=bnXor;BigInteger.prototype.andNot=bnAndNot;BigInteger.prototype.not=bnNot;BigInteger.prototype.shiftLeft=bnShiftLeft;BigInteger.prototype.shiftRight=bnShiftRight;BigInteger.prototype.getLowestSetBit=bnGetLowestSetBit;BigInteger.prototype.bitCount=bnBitCount;BigInteger.prototype.testBit=bnTestBit;BigInteger.prototype.setBit=bnSetBit;BigInteger.prototype.clearBit=bnClearBit;BigInteger.prototype.flipBit=bnFlipBit;BigInteger.prototype.add=bnAdd;BigInteger.prototype.subtract=bnSubtract;
BigInteger.prototype.multiply=bnMultiply;BigInteger.prototype.divide=bnDivide;BigInteger.prototype.remainder=bnRemainder;BigInteger.prototype.divideAndRemainder=bnDivideAndRemainder;BigInteger.prototype.modPow=bnModPow;BigInteger.prototype.modInverse=bnModInverse;BigInteger.prototype.pow=bnPow;BigInteger.prototype.gcd=bnGCD;BigInteger.prototype.isProbablePrime=bnIsProbablePrime;BigInteger.prototype.square=bnSquare;
(function(a,b,c,d,e,g,h){function f(a){var b,d,e=this,g=a.length,f=0,h=e.i=e.j=e.m=0;e.S=[];e.c=[];for(g||(a=[g++]);f<c;)e.S[f]=f++;for(f=0;f<c;f++)b=e.S[f],h=h+b+a[f%g]&c-1,d=e.S[h],e.S[f]=d,e.S[h]=b;e.g=function(a){var b=e.S,d=e.i+1&c-1,g=b[d],f=e.j+g&c-1,h=b[f];b[d]=h;b[f]=g;for(var k=b[g+h&c-1];--a;)d=d+1&c-1,g=b[d],f=f+g&c-1,h=b[f],b[d]=h,b[f]=g,k=k*c+b[g+h&c-1];e.i=d;e.j=f;return k};e.g(c)}function o(a,b,c,d,e){c=[];e=typeof a;if(b&&e=="object")for(d in a)if(d.indexOf("S")<5)try{c.push(o(a[d],
b-1))}catch(g){}return c.length?c:a+(e!="string"?"\x00":"")}function p(a,b,d,e){a+="";for(e=d=0;e<a.length;e++){var g=b,f=e&c-1,h=(d^=b[e&c-1]*19)+a.charCodeAt(e);g[f]=h&c-1}a="";for(e in b)a+=String.fromCharCode(b[e]);return a}b.seedrandom=function(q,n){var k=[],j,q=p(o(n?[q,a]:arguments.length?q:[(new Date).getTime(),a,window],3),k);j=new f(k);p(j.S,a);b.random=function(){for(var a=j.g(d),b=h,f=0;a<e;)a=(a+f)*c,b*=c,f=j.g(1);for(;a>=g;)a/=2,b/=2,f>>>=1;return(a+f)/b};return q};h=b.pow(c,d);e=b.pow(2,
e);g=e*2;p(b.random(),a)})([],Math,256,6,52);function SeededRandom(){}function SRnextBytes(a){var b;for(b=0;b<a.length;b++)a[b]=Math.floor(Math.random()*256)}SeededRandom.prototype.nextBytes=SRnextBytes;function Arcfour(){this.j=this.i=0;this.S=[]}function ARC4init(a){var b,c,d;for(b=0;b<256;++b)this.S[b]=b;for(b=c=0;b<256;++b)c=c+this.S[b]+a[b%a.length]&255,d=this.S[b],this.S[b]=this.S[c],this.S[c]=d;this.j=this.i=0}
function ARC4next(){var a;this.i=this.i+1&255;this.j=this.j+this.S[this.i]&255;a=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=a;return this.S[a+this.S[this.i]&255]}Arcfour.prototype.init=ARC4init;Arcfour.prototype.next=ARC4next;function prng_newstate(){return new Arcfour}var rng_psize=256,rng_state,rng_pool,rng_pptr;
function rng_seed_int(a){rng_pool[rng_pptr++]^=a&255;rng_pool[rng_pptr++]^=a>>8&255;rng_pool[rng_pptr++]^=a>>16&255;rng_pool[rng_pptr++]^=a>>24&255;rng_pptr>=rng_psize&&(rng_pptr-=rng_psize)}function rng_seed_time(){rng_seed_int((new Date).getTime())}
if(rng_pool==null){rng_pool=[];rng_pptr=0;var t;if(navigator.appName=="Netscape"&&navigator.appVersion<"5"&&window.crypto){var z=window.crypto.random(32);for(t=0;t<z.length;++t)rng_pool[rng_pptr++]=z.charCodeAt(t)&255}for(;rng_pptr<rng_psize;)t=Math.floor(65536*Math.random()),rng_pool[rng_pptr++]=t>>>8,rng_pool[rng_pptr++]=t&255;rng_pptr=0;rng_seed_time()}
function rng_get_byte(){if(rng_state==null){rng_seed_time();rng_state=prng_newstate();rng_state.init(rng_pool);for(rng_pptr=0;rng_pptr<rng_pool.length;++rng_pptr)rng_pool[rng_pptr]=0;rng_pptr=0}return rng_state.next()}function rng_get_bytes(a){var b;for(b=0;b<a.length;++b)a[b]=rng_get_byte()}function SecureRandom(){}SecureRandom.prototype.nextBytes=rng_get_bytes;
function SHA256(a){function b(a,b){var c=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(c>>16)<<16|c&65535}function c(a,b){return a>>>b|a<<32-b}a=function(a){for(var a=a.replace(/\r\n/g,"\n"),b="",c=0;c<a.length;c++){var h=a.charCodeAt(c);h<128?b+=String.fromCharCode(h):(h>127&&h<2048?b+=String.fromCharCode(h>>6|192):(b+=String.fromCharCode(h>>12|224),b+=String.fromCharCode(h>>6&63|128)),b+=String.fromCharCode(h&63|128))}return b}(a);return function(a){for(var b="",c=0;c<a.length*4;c++)b+="0123456789abcdef".charAt(a[c>>
2]>>(3-c%4)*8+4&15)+"0123456789abcdef".charAt(a[c>>2]>>(3-c%4)*8&15);return b}(function(a,e){var g=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,
2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],h=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],f=Array(64),o,p,q,n,k,j,l,m,s,r,u,w;a[e>>5]|=128<<24-e%32;a[(e+64>>9<<4)+15]=e;for(s=0;s<a.length;s+=16){o=h[0];p=h[1];q=h[2];n=h[3];
k=h[4];j=h[5];l=h[6];m=h[7];for(r=0;r<64;r++)f[r]=r<16?a[r+s]:b(b(b(c(f[r-2],17)^c(f[r-2],19)^f[r-2]>>>10,f[r-7]),c(f[r-15],7)^c(f[r-15],18)^f[r-15]>>>3),f[r-16]),u=b(b(b(b(m,c(k,6)^c(k,11)^c(k,25)),k&j^~k&l),g[r]),f[r]),w=b(c(o,2)^c(o,13)^c(o,22),o&p^o&q^p&q),m=l,l=j,j=k,k=b(n,u),n=q,q=p,p=o,o=b(u,w);h[0]=b(o,h[0]);h[1]=b(p,h[1]);h[2]=b(q,h[2]);h[3]=b(n,h[3]);h[4]=b(k,h[4]);h[5]=b(j,h[5]);h[6]=b(l,h[6]);h[7]=b(m,h[7])}return h}(function(a){for(var b=[],c=0;c<a.length*8;c+=8)b[c>>5]|=(a.charCodeAt(c/
8)&255)<<24-c%32;return b}(a),a.length*8))}var sha256={hex:function(a){return SHA256(a)}};
function SHA1(a){function b(a,b){return a<<b|a>>>32-b}function c(a){var b="",c,d;for(c=7;c>=0;c--)d=a>>>c*4&15,b+=d.toString(16);return b}var d,e,g=Array(80),h=1732584193,f=4023233417,o=2562383102,p=271733878,q=3285377520,n,k,j,l,m,a=function(a){for(var a=a.replace(/\r\n/g,"\n"),b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):(d>127&&d<2048?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&
63|128))}return b}(a);n=a.length;var s=[];for(d=0;d<n-3;d+=4)e=a.charCodeAt(d)<<24|a.charCodeAt(d+1)<<16|a.charCodeAt(d+2)<<8|a.charCodeAt(d+3),s.push(e);switch(n%4){case 0:d=2147483648;break;case 1:d=a.charCodeAt(n-1)<<24|8388608;break;case 2:d=a.charCodeAt(n-2)<<24|a.charCodeAt(n-1)<<16|32768;break;case 3:d=a.charCodeAt(n-3)<<24|a.charCodeAt(n-2)<<16|a.charCodeAt(n-1)<<8|128}for(s.push(d);s.length%16!=14;)s.push(0);s.push(n>>>29);s.push(n<<3&4294967295);for(a=0;a<s.length;a+=16){for(d=0;d<16;d++)g[d]=
s[a+d];for(d=16;d<=79;d++)g[d]=b(g[d-3]^g[d-8]^g[d-14]^g[d-16],1);e=h;n=f;k=o;j=p;l=q;for(d=0;d<=19;d++)m=b(e,5)+(n&k|~n&j)+l+g[d]+1518500249&4294967295,l=j,j=k,k=b(n,30),n=e,e=m;for(d=20;d<=39;d++)m=b(e,5)+(n^k^j)+l+g[d]+1859775393&4294967295,l=j,j=k,k=b(n,30),n=e,e=m;for(d=40;d<=59;d++)m=b(e,5)+(n&k|n&j|k&j)+l+g[d]+2400959708&4294967295,l=j,j=k,k=b(n,30),n=e,e=m;for(d=60;d<=79;d++)m=b(e,5)+(n^k^j)+l+g[d]+3395469782&4294967295,l=j,j=k,k=b(n,30),n=e,e=m;h=h+e&4294967295;f=f+n&4294967295;o=o+k&4294967295;
p=p+j&4294967295;q=q+l&4294967295}m=c(h)+c(f)+c(o)+c(p)+c(q);return m.toLowerCase()}
var sha1={hex:function(a){return SHA1(a)}},MD5=function(a){function b(a,b){var c,d,e,f,g;e=a&2147483648;f=b&2147483648;c=a&1073741824;d=b&1073741824;g=(a&1073741823)+(b&1073741823);return c&d?g^2147483648^e^f:c|d?g&1073741824?g^3221225472^e^f:g^1073741824^e^f:g^e^f}function c(a,c,d,e,f,g,h){a=b(a,b(b(c&d|~c&e,f),h));return b(a<<g|a>>>32-g,c)}function d(a,c,d,e,f,g,h){a=b(a,b(b(c&e|d&~e,f),h));return b(a<<g|a>>>32-g,c)}function e(a,c,d,e,f,g,h){a=b(a,b(b(c^d^e,f),h));return b(a<<g|a>>>32-g,c)}function g(a,
c,d,e,f,g,h){a=b(a,b(b(d^(c|~e),f),h));return b(a<<g|a>>>32-g,c)}function h(a){var b="",c="",d;for(d=0;d<=3;d++)c=a>>>d*8&255,c="0"+c.toString(16),b+=c.substr(c.length-2,2);return b}var f=[],o,p,q,n,k,j,l,m,a=function(a){for(var a=a.replace(/\r\n/g,"\n"),b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);d<128?b+=String.fromCharCode(d):(d>127&&d<2048?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b}(a),
f=function(a){var b,c=a.length;b=c+8;for(var d=((b-b%64)/64+1)*16,e=Array(d-1),f=0,g=0;g<c;)b=(g-g%4)/4,f=g%4*8,e[b]|=a.charCodeAt(g)<<f,g++;e[(g-g%4)/4]|=128<<g%4*8;e[d-2]=c<<3;e[d-1]=c>>>29;return e}(a);k=1732584193;j=4023233417;l=2562383102;m=271733878;for(a=0;a<f.length;a+=16)o=k,p=j,q=l,n=m,k=c(k,j,l,m,f[a+0],7,3614090360),m=c(m,k,j,l,f[a+1],12,3905402710),l=c(l,m,k,j,f[a+2],17,606105819),j=c(j,l,m,k,f[a+3],22,3250441966),k=c(k,j,l,m,f[a+4],7,4118548399),m=c(m,k,j,l,f[a+5],12,1200080426),l=c(l,
m,k,j,f[a+6],17,2821735955),j=c(j,l,m,k,f[a+7],22,4249261313),k=c(k,j,l,m,f[a+8],7,1770035416),m=c(m,k,j,l,f[a+9],12,2336552879),l=c(l,m,k,j,f[a+10],17,4294925233),j=c(j,l,m,k,f[a+11],22,2304563134),k=c(k,j,l,m,f[a+12],7,1804603682),m=c(m,k,j,l,f[a+13],12,4254626195),l=c(l,m,k,j,f[a+14],17,2792965006),j=c(j,l,m,k,f[a+15],22,1236535329),k=d(k,j,l,m,f[a+1],5,4129170786),m=d(m,k,j,l,f[a+6],9,3225465664),l=d(l,m,k,j,f[a+11],14,643717713),j=d(j,l,m,k,f[a+0],20,3921069994),k=d(k,j,l,m,f[a+5],5,3593408605),
m=d(m,k,j,l,f[a+10],9,38016083),l=d(l,m,k,j,f[a+15],14,3634488961),j=d(j,l,m,k,f[a+4],20,3889429448),k=d(k,j,l,m,f[a+9],5,568446438),m=d(m,k,j,l,f[a+14],9,3275163606),l=d(l,m,k,j,f[a+3],14,4107603335),j=d(j,l,m,k,f[a+8],20,1163531501),k=d(k,j,l,m,f[a+13],5,2850285829),m=d(m,k,j,l,f[a+2],9,4243563512),l=d(l,m,k,j,f[a+7],14,1735328473),j=d(j,l,m,k,f[a+12],20,2368359562),k=e(k,j,l,m,f[a+5],4,4294588738),m=e(m,k,j,l,f[a+8],11,2272392833),l=e(l,m,k,j,f[a+11],16,1839030562),j=e(j,l,m,k,f[a+14],23,4259657740),
k=e(k,j,l,m,f[a+1],4,2763975236),m=e(m,k,j,l,f[a+4],11,1272893353),l=e(l,m,k,j,f[a+7],16,4139469664),j=e(j,l,m,k,f[a+10],23,3200236656),k=e(k,j,l,m,f[a+13],4,681279174),m=e(m,k,j,l,f[a+0],11,3936430074),l=e(l,m,k,j,f[a+3],16,3572445317),j=e(j,l,m,k,f[a+6],23,76029189),k=e(k,j,l,m,f[a+9],4,3654602809),m=e(m,k,j,l,f[a+12],11,3873151461),l=e(l,m,k,j,f[a+15],16,530742520),j=e(j,l,m,k,f[a+2],23,3299628645),k=g(k,j,l,m,f[a+0],6,4096336452),m=g(m,k,j,l,f[a+7],10,1126891415),l=g(l,m,k,j,f[a+14],15,2878612391),
j=g(j,l,m,k,f[a+5],21,4237533241),k=g(k,j,l,m,f[a+12],6,1700485571),m=g(m,k,j,l,f[a+3],10,2399980690),l=g(l,m,k,j,f[a+10],15,4293915773),j=g(j,l,m,k,f[a+1],21,2240044497),k=g(k,j,l,m,f[a+8],6,1873313359),m=g(m,k,j,l,f[a+15],10,4264355552),l=g(l,m,k,j,f[a+6],15,2734768916),j=g(j,l,m,k,f[a+13],21,1309151649),k=g(k,j,l,m,f[a+4],6,4149444226),m=g(m,k,j,l,f[a+11],10,3174756917),l=g(l,m,k,j,f[a+2],15,718787259),j=g(j,l,m,k,f[a+9],21,3951481745),k=b(k,o),j=b(j,p),l=b(l,q),m=b(m,n);return(h(k)+h(j)+h(l)+
h(m)).toLowerCase()};function parseBigInt(a,b){return new BigInteger(a,b)}function linebrk(a,b){for(var c="",d=0;d+b<a.length;)c+=a.substring(d,d+b)+"\n",d+=b;return c+a.substring(d,a.length)}function byte2Hex(a){return a<16?"0"+a.toString(16):a.toString(16)}
function pkcs1pad2(a,b){if(b<a.length+11)throw"Message too long for RSA (n="+b+", l="+a.length+")";for(var c=[],d=a.length-1;d>=0&&b>0;){var e=a.charCodeAt(d--);e<128?c[--b]=e:e>127&&e<2048?(c[--b]=e&63|128,c[--b]=e>>6|192):(c[--b]=e&63|128,c[--b]=e>>6&63|128,c[--b]=e>>12|224)}c[--b]=0;d=new SecureRandom;for(e=[];b>2;){for(e[0]=0;e[0]==0;)d.nextBytes(e);c[--b]=e[0]}c[--b]=2;c[--b]=0;return new BigInteger(c)}
function RSAKey(){this.n=null;this.e=0;this.coeff=this.dmq1=this.dmp1=this.q=this.p=this.d=null}function RSASetPublic(a,b){a!=null&&b!=null&&a.length>0&&b.length>0?(this.n=parseBigInt(a,16),this.e=parseInt(b,16)):alert("Invalid RSA public key")}function RSADoPublic(a){return a.modPowInt(this.e,this.n)}function RSAEncrypt(a){a=pkcs1pad2(a,this.n.bitLength()+7>>3);if(a==null)return null;a=this.doPublic(a);if(a==null)return null;a=a.toString(16);return(a.length&1)==0?a:"0"+a}
// -- rev 1.1.0 追加ここから
function RSAToJSON(){return {coeff: this.coeff.toString(16),d: this.d.toString(16),dmp1: this.dmp1.toString(16),dmq1: this.dmq1.toString(16),e: this.e.toString(16),n: this.n.toString(16),p: this.p.toString(16),q: this.q.toString(16)}}
function RSAParse(rsaString) {var json=JSON.parse(rsaString);var rsa = new RSAKey();rsa.setPrivateEx(json.n,json.e,json.d,json.p,json.q,json.dmp1,json.dmq1,json.coeff);return rsa;}
RSAKey.prototype.toJSON = RSAToJSON;RSAKey.parse = RSAParse;
// -- rev 1.1.0 追加ここまで
RSAKey.prototype.doPublic=RSADoPublic;RSAKey.prototype.setPublic=RSASetPublic;RSAKey.prototype.encrypt=RSAEncrypt;function pkcs1unpad2(a,b){for(var c=a.toByteArray(),d=0;d<c.length&&c[d]==0;)++d;if(c.length-d!=b-1||c[d]!=2)return null;for(++d;c[d]!=0;)if(++d>=c.length)return null;for(var e="";++d<c.length;){var g=c[d]&255;g<128?e+=String.fromCharCode(g):g>191&&g<224?(e+=String.fromCharCode((g&31)<<6|c[d+1]&63),++d):(e+=String.fromCharCode((g&15)<<12|(c[d+1]&63)<<6|c[d+2]&63),d+=2)}return e}
function RSASetPrivate(a,b,c){a!=null&&b!=null&&a.length>0&&b.length>0?(this.n=parseBigInt(a,16),this.e=parseInt(b,16),this.d=parseBigInt(c,16)):alert("Invalid RSA private key")}
function RSASetPrivateEx(a,b,c,d,e,g,h,f){a!=null&&b!=null&&a.length>0&&b.length>0?(this.n=parseBigInt(a,16),this.e=parseInt(b,16),this.d=parseBigInt(c,16),this.p=parseBigInt(d,16),this.q=parseBigInt(e,16),this.dmp1=parseBigInt(g,16),this.dmq1=parseBigInt(h,16),this.coeff=parseBigInt(f,16)):alert("Invalid RSA private key")}
function RSAGenerate(a,b){var c=new SeededRandom,d=a>>1;this.e=parseInt(b,16);for(var e=new BigInteger(b,16);;){for(;;)if(this.p=new BigInteger(a-d,1,c),this.p.subtract(BigInteger.ONE).gcd(e).compareTo(BigInteger.ONE)==0&&this.p.isProbablePrime(10))break;for(;;)if(this.q=new BigInteger(d,1,c),this.q.subtract(BigInteger.ONE).gcd(e).compareTo(BigInteger.ONE)==0&&this.q.isProbablePrime(10))break;if(this.p.compareTo(this.q)<=0){var g=this.p;this.p=this.q;this.q=g}var g=this.p.subtract(BigInteger.ONE),
h=this.q.subtract(BigInteger.ONE),f=g.multiply(h);if(f.gcd(e).compareTo(BigInteger.ONE)==0){this.n=this.p.multiply(this.q);this.d=e.modInverse(f);this.dmp1=this.d.mod(g);this.dmq1=this.d.mod(h);this.coeff=this.q.modInverse(this.p);break}}}
function RSADoPrivate(a){if(this.p==null||this.q==null)return a.modPow(this.d,this.n);for(var b=a.mod(this.p).modPow(this.dmp1,this.p),a=a.mod(this.q).modPow(this.dmq1,this.q);b.compareTo(a)<0;)b=b.add(this.p);return b.subtract(a).multiply(this.coeff).mod(this.p).multiply(this.q).add(a)}function RSADecrypt(a){a=this.doPrivate(parseBigInt(a,16));return a==null?null:pkcs1unpad2(a,this.n.bitLength()+7>>3)}RSAKey.prototype.doPrivate=RSADoPrivate;RSAKey.prototype.setPrivate=RSASetPrivate;
RSAKey.prototype.setPrivateEx=RSASetPrivateEx;RSAKey.prototype.generate=RSAGenerate;RSAKey.prototype.decrypt=RSADecrypt;var _RSASIGN_DIHEAD=[];_RSASIGN_DIHEAD.sha1="3021300906052b0e03021a05000414";_RSASIGN_DIHEAD.sha256="3031300d060960864801650304020105000420";var _RSASIGN_HASHHEXFUNC=[];_RSASIGN_HASHHEXFUNC.sha1=sha1.hex;_RSASIGN_HASHHEXFUNC.sha256=sha256.hex;
function _rsasign_getHexPaddedDigestInfoForString(a,b,c){b/=4;for(var a=(0,_RSASIGN_HASHHEXFUNC[c])(a),c="00"+_RSASIGN_DIHEAD[c]+a,a="",b=b-4-c.length,d=0;d<b;d+=2)a+="ff";return sPaddedMessageHex="0001"+a+c}function _rsasign_signString(a,b){var c=_rsasign_getHexPaddedDigestInfoForString(a,this.n.bitLength(),b);return this.doPrivate(parseBigInt(c,16)).toString(16)}
function _rsasign_signStringWithSHA1(a){a=_rsasign_getHexPaddedDigestInfoForString(a,this.n.bitLength(),"sha1");return this.doPrivate(parseBigInt(a,16)).toString(16)}function _rsasign_signStringWithSHA256(a){a=_rsasign_getHexPaddedDigestInfoForString(a,this.n.bitLength(),"sha256");return this.doPrivate(parseBigInt(a,16)).toString(16)}function _rsasign_getDecryptSignatureBI(a,b,c){var d=new RSAKey;d.setPublic(b,c);return d.doPublic(a)}
function _rsasign_getHexDigestInfoFromSig(a,b,c){return _rsasign_getDecryptSignatureBI(a,b,c).toString(16).replace(/^1f+00/,"")}function _rsasign_getAlgNameAndHashFromHexDisgestInfo(a){for(var b in _RSASIGN_DIHEAD){var c=_RSASIGN_DIHEAD[b],d=c.length;if(a.substring(0,d)==c)return[b,a.substring(d)]}return[]}
function _rsasign_verifySignatureWithArgs(a,b,c,d){b=_rsasign_getHexDigestInfoFromSig(b,c,d);c=_rsasign_getAlgNameAndHashFromHexDisgestInfo(b);if(c.length==0)return!1;b=c[1];a=(0,_RSASIGN_HASHHEXFUNC[c[0]])(a);return b==a}function _rsasign_verifyHexSignatureForMessage(a,b){var c=parseBigInt(a,16);return _rsasign_verifySignatureWithArgs(b,c,this.n.toString(16),this.e.toString(16))}
function _rsasign_verifyString(a,b){var b=b.replace(/[ \n]+/g,""),c=this.doPublic(parseBigInt(b,16)).toString(16).replace(/^1f+00/,""),d=_rsasign_getAlgNameAndHashFromHexDisgestInfo(c);if(d.length==0)return!1;c=d[1];d=(0,_RSASIGN_HASHHEXFUNC[d[0]])(a);return c==d}RSAKey.prototype.signString=_rsasign_signString;RSAKey.prototype.signStringWithSHA1=_rsasign_signStringWithSHA1;RSAKey.prototype.signStringWithSHA256=_rsasign_signStringWithSHA256;RSAKey.prototype.verifyString=_rsasign_verifyString;
RSAKey.prototype.verifyHexSignatureForMessage=_rsasign_verifyHexSignatureForMessage;
var aes=function(){var a={Sbox:[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,
95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],ShiftRowTab:[0,5,10,15,4,9,14,3,8,13,2,7,12,1,6,11]};a.Init=
function(){a.Sbox_Inv=Array(256);for(var b=0;b<256;b++)a.Sbox_Inv[a.Sbox[b]]=b;a.ShiftRowTab_Inv=Array(16);for(b=0;b<16;b++)a.ShiftRowTab_Inv[a.ShiftRowTab[b]]=b;a.xtime=Array(256);for(b=0;b<128;b++)a.xtime[b]=b<<1,a.xtime[128+b]=b<<1^27};a.Done=function(){delete a.Sbox_Inv;delete a.ShiftRowTab_Inv;delete a.xtime};a.ExpandKey=function(b){var c=b.length,d,e=1;switch(c){case 16:d=176;break;case 24:d=208;break;case 32:d=240;break;default:alert("my.ExpandKey: Only key lengths of 16, 24 or 32 bytes allowed!")}for(var g=
c;g<d;g+=4){var h=b.slice(g-4,g);if(g%c==0){if(h=[a.Sbox[h[1]]^e,a.Sbox[h[2]],a.Sbox[h[3]],a.Sbox[h[0]]],(e<<=1)>=256)e^=283}else c>24&&g%c==16&&(h=[a.Sbox[h[0]],a.Sbox[h[1]],a.Sbox[h[2]],a.Sbox[h[3]]]);for(var f=0;f<4;f++)b[g+f]=b[g+f-c]^h[f]}};a.Encrypt=function(b,c){var d=c.length;a.AddRoundKey(b,c.slice(0,16));for(var e=16;e<d-16;e+=16)a.SubBytes(b,a.Sbox),a.ShiftRows(b,a.ShiftRowTab),a.MixColumns(b),a.AddRoundKey(b,c.slice(e,e+16));a.SubBytes(b,a.Sbox);a.ShiftRows(b,a.ShiftRowTab);a.AddRoundKey(b,
c.slice(e,d))};a.Decrypt=function(b,c){var d=c.length;a.AddRoundKey(b,c.slice(d-16,d));a.ShiftRows(b,a.ShiftRowTab_Inv);a.SubBytes(b,a.Sbox_Inv);for(d-=32;d>=16;d-=16)a.AddRoundKey(b,c.slice(d,d+16)),a.MixColumns_Inv(b),a.ShiftRows(b,a.ShiftRowTab_Inv),a.SubBytes(b,a.Sbox_Inv);a.AddRoundKey(b,c.slice(0,16))};a.SubBytes=function(a,c){for(var d=0;d<16;d++)a[d]=c[a[d]]};a.AddRoundKey=function(a,c){for(var d=0;d<16;d++)a[d]^=c[d]};a.ShiftRows=function(a,c){for(var d=[].concat(a),e=0;e<16;e++)a[e]=d[c[e]]};
a.MixColumns=function(b){for(var c=0;c<16;c+=4){var d=b[c+0],e=b[c+1],g=b[c+2],h=b[c+3],f=d^e^g^h;b[c+0]^=f^a.xtime[d^e];b[c+1]^=f^a.xtime[e^g];b[c+2]^=f^a.xtime[g^h];b[c+3]^=f^a.xtime[h^d]}};a.MixColumns_Inv=function(b){for(var c=0;c<16;c+=4){var d=b[c+0],e=b[c+1],g=b[c+2],h=b[c+3],f=d^e^g^h,o=a.xtime[f],p=a.xtime[a.xtime[o^d^g]]^f;f^=a.xtime[a.xtime[o^e^h]];b[c+0]^=p^a.xtime[d^e];b[c+1]^=f^a.xtime[e^g];b[c+2]^=p^a.xtime[g^h];b[c+3]^=f^a.xtime[h^d]}};return a}(),cryptico=function(){var a={};aes.Init();
a.b256to64=function(a){var c,d,e,g="",h=0,f=0,o=a.length;for(e=0;e<o;e++)d=a.charCodeAt(e),f==0?(g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>2&63),c=(d&3)<<4):f==1?(g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(c|d>>4&15),c=(d&15)<<2):f==2&&(g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(c|d>>6&3),h+=1,g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d&63)),h+=1,f+=1,f==3&&
(f=0);f>0&&(g+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(c),g+="=");f==1&&(g+="=");return g};a.b64to256=function(a){var c,d,e="",g=0,h=0,f=a.length;for(d=0;d<f;d++)c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a.charAt(d)),c>=0&&(g&&(e+=String.fromCharCode(h|c>>6-g&255)),g=g+2&7,h=c<<g&255);return e};a.b16to64=function(a){var c,d,e="";a.length%2==1&&(a="0"+a);for(c=0;c+3<=a.length;c+=3)d=parseInt(a.substring(c,c+3),16),e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>
6)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d&63);c+1==a.length?(d=parseInt(a.substring(c,c+1),16),e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d<<2)):c+2==a.length&&(d=parseInt(a.substring(c,c+2),16),e+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(d>>2)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt((d&3)<<4));for(;(e.length&3)>0;)e+="=";return e};a.b64to16=function(a){var c="",
d,e=0,g;for(d=0;d<a.length;++d){if(a.charAt(d)=="=")break;v="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a.charAt(d));v<0||(e==0?(c+=int2char(v>>2),g=v&3,e=1):e==1?(c+=int2char(g<<2|v>>4),g=v&15,e=2):e==2?(c+=int2char(g),c+=int2char(v>>2),g=v&3,e=3):(c+=int2char(g<<2|v>>4),c+=int2char(v&15),e=0))}e==1&&(c+=int2char(g<<2));return c};a.string2bytes=function(a){for(var c=[],d=0;d<a.length;d++)c.push(a.charCodeAt(d));return c};a.bytes2string=function(a){for(var c="",d=0;d<
a.length;d++)c+=String.fromCharCode(a[d]);return c};a.blockXOR=function(a,c){for(var d=Array(16),e=0;e<16;e++)d[e]=a[e]^c[e];return d};a.blockIV=function(){var a=new SecureRandom,c=Array(16);a.nextBytes(c);return c};a.pad16=function(a){var c=a.slice(0),d=(16-a.length%16)%16;for(i=a.length;i<a.length+d;i++)c.push(0);return c};a.depad=function(a){for(a=a.slice(0);a[a.length-1]==0;)a=a.slice(0,a.length-1);return a};a.encryptAESCBC=function(b,c){var d=c.slice(0);aes.ExpandKey(d);for(var e=a.string2bytes(b),
e=a.pad16(e),g=a.blockIV(),h=0;h<e.length/16;h++){var f=e.slice(h*16,h*16+16),o=g.slice(h*16,h*16+16),f=a.blockXOR(o,f);aes.Encrypt(f,d);g=g.concat(f)}d=a.bytes2string(g);return a.b256to64(d)};a.decryptAESCBC=function(b,c){var d=c.slice(0);aes.ExpandKey(d);for(var b=a.b64to256(b),e=a.string2bytes(b),g=[],h=1;h<e.length/16;h++){var f=e.slice(h*16,h*16+16),o=e.slice((h-1)*16,(h-1)*16+16);aes.Decrypt(f,d);f=a.blockXOR(o,f);g=g.concat(f)}g=a.depad(g);return a.bytes2string(g)};a.wrap60=function(a){for(var c=
"",d=0;d<a.length;d++)d%60==0&&d!=0&&(c+="\n"),c+=a[d];return c};a.generateAESKey=function(){var a=Array(32);(new SecureRandom).nextBytes(a);return a};a.generateRSAKey=function(a,c){Math.seedrandom(sha256.hex(a));var d=new RSAKey;d.generate(c,"03");return d};a.publicKeyString=function(b){return pubkey=a.b16to64(b.n.toString(16))};a.publicKeyID=function(a){return MD5(a)};a.publicKeyFromString=function(b){var b=a.b64to16(b.split("|")[0]),c=new RSAKey;c.setPublic(b,"03");return c};a.encrypt=function(b,
c,d){var e="",g=a.generateAESKey();try{var h=a.publicKeyFromString(c);e+=a.b16to64(h.encrypt(a.bytes2string(g)))+"?"}catch(f){return{status:"Invalid public key"}}d&&(signString=cryptico.b16to64(d.signString(b,"sha256")),b+="::52cee64bb3a38f6403386519a39ac91c::",b+=cryptico.publicKeyString(d),b+="::52cee64bb3a38f6403386519a39ac91c::",b+=signString);e+=a.encryptAESCBC(b,g);return{status:"success",cipher:e}};a.decrypt=function(b,c){var d=b.split("?"),e=c.decrypt(a.b64to16(d[0]));if(e==null)return{status:"failure"};
e=a.string2bytes(e);d=a.decryptAESCBC(d[1],e).split("::52cee64bb3a38f6403386519a39ac91c::");if(d.length==3){var e=a.publicKeyFromString(d[1]),g=a.b64to16(d[2]);return e.verifyString(d[0],g)?{status:"success",plaintext:d[0],signature:"verified",publicKeyString:a.publicKeyString(e)}:{status:"success",plaintext:d[0],signature:"forged",publicKeyString:a.publicKeyString(e)}}else return{status:"success",plaintext:d[0],signature:"unsigned"}};return a}();
</script>
</html>
